<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,height=device-height,initial-scale=1.0" />
<title>–†–µ–¥–∞–∫—Ç–æ—Ä ¬´–ù–∞–π–¥–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞¬ª (Genially fullscreen + adaptive)</title>
<style>
  :root{
    --bg1:#0b1020;
    --panel:rgba(20,24,40,.75);
    --stroke:rgba(255,255,255,.10);
    --txt:rgba(255,255,255,.92);
    --muted:rgba(255,255,255,.65);
    --btn:#2d6cff;
    --ok:#22c55e;
  }
  html,body{margin:0;height:100%;background:var(--bg1);font-family:system-ui,-apple-system,Segoe UI,Roboto; color:var(--txt); overflow:hidden;}
  .app{position:fixed; inset:0; display:grid; grid-template-columns: 380px 1fr; gap:14px; padding:14px; box-sizing:border-box;}
  @media (max-width: 980px){ .app{grid-template-columns:1fr; grid-template-rows:auto 1fr;} }

  .panel{
    background:var(--panel); border:1px solid var(--stroke); border-radius:18px;
    padding:14px 14px 12px; overflow:auto; backdrop-filter: blur(10px);
  }
  .title{font-size:18px; font-weight:700; margin:0 0 8px;}
  .desc{font-size:12px; color:var(--muted); line-height:1.35; margin:0 0 12px;}
  .field{margin:10px 0;}
  label{display:block;font-size:12px;color:var(--muted); margin:0 0 4px;}
  input,select,textarea{
    width:100%; box-sizing:border-box;
    background:#101a36; border:1px solid rgba(255,255,255,.10);
    color:var(--txt); border-radius:10px; padding:8px 10px; outline:none;
  }
  input[type="range"]{padding:0; height:28px;}
  textarea{min-height:70px; resize:vertical;}
  .row{display:grid; grid-template-columns:1fr 1fr; gap:10px;}
  .btnRow{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;}
  button{border:none; border-radius:12px; padding:10px 12px; cursor:pointer; font-weight:700; color:white; background:rgba(255,255,255,.12);}
  button.primary{background:var(--btn);}
  button.success{background:var(--ok); color:#062012;}
  button.ghost{background:rgba(255,255,255,.10);}

  .codeBox{margin-top:10px; border:1px solid rgba(255,255,255,.10); border-radius:14px; background:rgba(0,0,0,.25); padding:10px;}
  .codeBox .cap{font-size:12px;color:var(--muted); margin:0 0 8px;}
  #out{width:100%; min-height:230px; font-family: ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; font-size:12px; line-height:1.35; white-space:pre;}
  .hint{margin-top:8px;font-size:12px;color:var(--muted);}
  .warn{margin-top:8px;font-size:12px;color:#ffd27a;display:none;}

  .stage{
    position:relative; border-radius:18px; overflow:hidden; border:1px solid var(--stroke);
    background:
      repeating-linear-gradient(135deg, rgba(255,255,255,.05) 0, rgba(255,255,255,.05) 8px, rgba(255,255,255,.02) 8px, rgba(255,255,255,.02) 16px),
      linear-gradient(180deg, rgba(15,24,50,.55), rgba(0,0,0,.25));
  }
  .topBanner{
    position:absolute; top:14px; left:50%; transform:translateX(-50%);
    background:rgba(0,0,0,.55); border:1px solid rgba(255,255,255,.12);
    border-radius:999px; padding:8px 14px; font-size:14px;
    box-shadow:0 10px 30px rgba(0,0,0,.25);
    pointer-events:none;
    max-width:min(720px, calc(100% - 180px));
    text-align:center; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    z-index:6;
  }
  .hud{
    position:absolute; top:14px; right:14px;
    display:flex; gap:10px; align-items:center;
    z-index:7;
  }
  .lamp{
    width:38px; height:38px; border-radius:50%;
    border:1px solid rgba(255,255,255,.14);
    background:rgba(255,255,255,.14);
    display:grid; place-items:center;
    cursor:pointer; user-select:none;
    box-shadow:0 10px 30px rgba(0,0,0,.25);
  }
  .lamp:active{transform:translateY(1px);}
  .count{
    background:rgba(0,0,0,.45); border:1px solid rgba(255,255,255,.12);
    padding:6px 10px; border-radius:999px; font-size:13px;
    min-width:52px; text-align:center;
    box-shadow:0 10px 30px rgba(0,0,0,.25);
  }

  .sprite{
    position:absolute;
    left:50%; top:55%;
    transform:translate(-50%,-50%) translateZ(0);
    -webkit-transform:translate(-50%,-50%) translateZ(0);
    backface-visibility:hidden;
    cursor:pointer;
    user-select:none;
    -webkit-user-drag:none;
    will-change:left,top,opacity,filter;
    z-index:2147483000;
    opacity:1;
    pointer-events:auto;
    transition:opacity 120ms ease;
  }

  .anim-none{opacity:1;}
  .anim-pop{animation:popIn var(--dur) ease-out both;}
  @keyframes popIn{from{transform:translate(-50%,-50%) scale(.6); opacity:0;} to{transform:translate(-50%,-50%) scale(1); opacity:1;}}
  .anim-fade{animation:fadeIn var(--dur) ease-out both;}
  @keyframes fadeIn{from{opacity:0;} to{opacity:1;}}
  .anim-soft{animation:softIn var(--dur) ease-out both;}
  @keyframes softIn{from{opacity:0; filter:blur(6px);} to{opacity:1; filter:blur(0);}}
  .pulseHint{animation:pulse 700ms ease-in-out 0s 3;}
  @keyframes pulse{0%,100%{transform:translate(-50%,-50%) scale(1);}50%{transform:translate(-50%,-50%) scale(1.15);}}
</style>
</head>

<body>
<div class="app" id="APP">
  <div class="panel">
    <div class="title">–†–µ–¥–∞–∫—Ç–æ—Ä ¬´–ù–∞–π–¥–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞¬ª</div>
    <p class="desc">–ù–∞—Å—Ç—Ä–æ–π –ø–∞—Ä–∞–º–µ—Ç—Ä—ã ‚Üí ¬´–ü–æ–ª—É—á–∏—Ç—å –∫–æ–¥¬ª ‚Üí –≤—Å—Ç–∞–≤—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ Genially (HTML/Embed).</p>

    <div class="field">
      <label>URL –∫–∞—Ä—Ç–∏–Ω–∫–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ (–º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –ø—É—Å—Ç—ã–º)</label>
      <input id="imgUrl" placeholder="https://.../image.png">
      <div class="hint">–ï—Å–ª–∏ –ø—É—Å—Ç–æ ‚Äî –±–µ—Ä—ë–º –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è <b>babochka_2</b>, —Ñ–∞–π–ª <b>babushka_2</b> (+ –≤–∞—Ä–∏–∞–Ω—Ç—ã —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π).</div>
      <div class="warn" id="imgWarn">‚ö†Ô∏è –ö–∞—Ä—Ç–∏–Ω–∫–∞ –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–∞—Å—å. –ü—Ä–æ–≤–µ—Ä—å –∏–º—è —Ñ–∞–π–ª–∞/—Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏.</div>
    </div>

    <div class="row">
      <div class="field">
        <label>–†–∞–∑–º–µ—Ä (px)</label>
        <input type="range" id="size" min="20" max="220" value="46">
        <div class="hint"><span id="sizeVal">46</span> px</div>
      </div>
      <div class="field">
        <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞—Ö–æ–¥–æ–∫ (—Ä–∞—É–Ω–¥–æ–≤)</label>
        <input type="number" id="rounds" min="1" max="50" value="7">
      </div>
    </div>

    <div class="row">
      <div class="field">
        <label>–û—Ç—Å—Ç—É–ø –æ—Ç –∫—Ä–∞—ë–≤ (px)</label>
        <input type="number" id="pad" min="0" max="240" value="18">
      </div>
      <div class="field">
        <label>–ü–∞—É–∑–∞ –º–µ–∂–¥—É —Ä–∞—É–Ω–¥–∞–º–∏ (–º—Å)</label>
        <input type="number" id="pause" min="0" max="5000" value="200">
      </div>
    </div>

    <div class="row">
      <div class="field">
        <label>–ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è</label>
        <select id="anim">
          <option value="soft" selected>soft fade (–º–µ–¥–ª–µ–Ω–Ω–æ)</option>
          <option value="fade">fade</option>
          <option value="pop">pop</option>
          <option value="none">–±–µ–∑ –∞–Ω–∏–º–∞—Ü–∏–∏</option>
        </select>
      </div>
      <div class="field">
        <label>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∞–Ω–∏–º–∞—Ü–∏–∏ (–º—Å)</label>
        <input type="number" id="dur" min="0" max="5000" value="1100">
      </div>
    </div>

    <div class="field">
      <label>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è (–ø–ª–∞—à–∫–∞ —Å–≤–µ—Ä—Ö—É –ø–æ —Ü–µ–Ω—Ç—Ä—É)</label>
      <input id="task" value="–ù–∞–π–¥–∏ –±–∞–±–æ—á–∫—É –∏ –Ω–∞–∂–º–∏ –Ω–∞ –Ω–µ—ë!">
    </div>

    <div class="field">
      <label>–¢–µ–∫—Å—Ç –≤ –∫–æ–Ω—Ü–µ –∏–≥—Ä—ã</label>
      <textarea id="endText">–ú–æ–ª–æ–¥–µ—Ü! –ü—Ä–∏—Ö–æ–¥–∏ –∏–≥—Ä–∞—Ç—å –µ—â—ë —Ä–∞–∑ üòä</textarea>
    </div>

    <div class="row">
      <div class="field">
        <label>–ó–æ–Ω–∞ —Å—Ç—Ä–µ–ª–æ–∫ —Å–ª–µ–≤–∞/—Å–ø—Ä–∞–≤–∞ (px)</label>
        <input type="number" id="arrowW" min="60" max="260" value="170">
      </div>
      <div class="field">
        <label>–í—ã—Å–æ—Ç–∞ –∑–æ–Ω—ã —Å—Ç—Ä–µ–ª–æ–∫ (px)</label>
        <input type="number" id="arrowH" min="120" max="420" value="320">
      </div>
    </div>

    <div class="row">
      <div class="field">
        <label>–õ–æ–≥–æ Genially —Å–ª–µ–≤–∞ —Å–Ω–∏–∑—É (w√óh, px)</label>
        <input type="text" id="logoBox" value="200x95">
        <div class="hint">–§–æ—Ä–º–∞—Ç: 200x95</div>
      </div>
      <div class="field">
        <label>&nbsp;</label>
        <div class="hint">–í–µ—Ä—Å–∏—è: adaptive + fullscreen-safe (–ø–æ–∑–∏—Ü–∏–∏ –ø–æ –≤—Å–µ–º—É iframe).</div>
      </div>
    </div>

    <div class="btnRow">
      <button class="primary" id="btnCode">–ü–æ–ª—É—á–∏—Ç—å –∫–æ–¥</button>
      <button class="success" id="btnCopy">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥</button>
      <button class="ghost" id="btnReset">–°–±—Ä–æ—Å</button>
    </div>

    <div class="codeBox">
      <div class="cap">HTML-–∫–æ–¥ –¥–ª—è Genially (DIV + STYLE + SCRIPT)</div>
      <textarea id="out" readonly placeholder="–ù–∞–∂–º–∏ ¬´–ü–æ–ª—É—á–∏—Ç—å –∫–æ–¥¬ª"></textarea>
      <div class="hint">Genially ‚Üí Insert ‚Üí Others ‚Üí Embed ‚Üí Insert external content (HTML).</div>
    </div>
  </div>

  <div class="stage" id="stage">
    <div class="topBanner" id="banner">–ù–∞–π–¥–∏ –±–∞–±–æ—á–∫—É –∏ –Ω–∞–∂–º–∏ –Ω–∞ –Ω–µ—ë!</div>
    <div class="hud" id="hud">
      <div class="lamp" id="lamp" title="–ü–æ–¥—Å–∫–∞–∑–∫–∞">üí°</div>
      <div class="count" id="count">0/7</div>
    </div>
    <img class="sprite" id="sprite" alt="sprite" draggable="false" />
  </div>
</div>

<script>
(() => {
  const $ = (id)=>document.getElementById(id);
  const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
  const parseBox=(s,defW,defH)=>{
    const m = String(s||"").toLowerCase().match(/(\d+)\s*x\s*(\d+)/);
    if(!m) return {w:defW,h:defH};
    return {w:+m[1],h:+m[2]};
  };

  // === —Ä–µ–ø–æ/–ø–∞–ø–∫–∞ ===
  const BASE = "https://propodgotovkaa-creator.github.io/babochka_2/";
  const DEFAULT_CANDIDATES = [
    BASE + "babushka_2.png",
    BASE + "babushka_2.webp",
    BASE + "babushka_2.svg",
    BASE + "babushka_2.jpg",
    BASE + "babushka_2",
  ];

  const FALLBACK_SVG = "data:image/svg+xml;charset=utf-8," + encodeURIComponent(`
    <svg xmlns="http://www.w3.org/2000/svg" width="140" height="110" viewBox="0 0 140 110">
      <path d="M70 62c-8-26-35-40-54-30-15 8-10 34 11 47 20 12 35 0 43-17z" fill="#7ee3ff"/>
      <path d="M70 62c8-26 35-40 54-30 15 8 10 34-11 47-20 12-35 0-43-17z" fill="#7ee3ff"/>
      <path d="M67 65c-2 11 2 25 2 25h6s4-14 2-25c-1-7-7-7-10 0z" fill="#0b1020"/>
      <circle cx="70" cy="56" r="5" fill="#0b1020"/>
    </svg>
  `);

  // ===== RNG: –Ω–æ–≤—ã–π seed –Ω–∞ –∫–∞–∂–¥—ã–π –∑–∞–ø—É—Å–∫ + –Ω–∞ resume =====
  let SEED = 0xA5A5A5A5 >>> 0;
  let GAME_COUNTER = 0;
  function reseed(tag){
    GAME_COUNTER++;
    let r0 = 0, r1 = 0;
    try{
      const a = new Uint32Array(2);
      if(window.crypto && crypto.getRandomValues){
        crypto.getRandomValues(a);
        r0=a[0]>>>0; r1=a[1]>>>0;
      }else{
        r0 = (Math.random()*4294967296)>>>0;
        r1 = (Date.now()>>>0) ^ ((performance.now()*1000)>>>0);
      }
    }catch(e){
      r0 = (Date.now()>>>0);
      r1 = ((performance.now()*1000)>>>0);
    }
    const mix = (String(location.href||"") + "|" + String(tag||"") + "|" + String(GAME_COUNTER));
    let h = 2166136261>>>0;
    for(let i=0;i<mix.length;i++){ h ^= mix.charCodeAt(i); h = Math.imul(h, 16777619); }
    SEED = (r0 ^ r1 ^ h ^ (Date.now()>>>0) ^ (GAME_COUNTER>>>0)) >>> 0;
    if(SEED===0) SEED = 0x9E3779B9;
  }
  function rand(){
    SEED ^= (SEED << 13) >>> 0;
    SEED ^= (SEED >>> 17) >>> 0;
    SEED ^= (SEED << 5) >>> 0;
    return (SEED>>>0)/4294967296;
  }

  const stage = $("stage");
  const sprite = $("sprite");
  const banner = $("banner");
  const hud = $("hud");
  const count = $("count");
  const lamp  = $("lamp");
  const imgWarn = $("imgWarn");
  const out = $("out");

  let cfg = {};
  let found = 0;
  let history = [];
  const HISTORY_MAX = 18;
  let lastGood = {x:null,y:null};
  let placeToken = 0;

  function readCfg(){
    const logo = parseBox($("logoBox").value, 200, 95);
    cfg = {
      imgUrl: $("imgUrl").value.trim(),
      size: +$("size").value,
      rounds: +$("rounds").value,
      pad: +$("pad").value,
      pause: +$("pause").value,
      anim: $("anim").value,
      dur: +$("dur").value,
      task: $("task").value,
      endText: $("endText").value,
      arrowW: +$("arrowW").value,
      arrowH: +$("arrowH").value,
      logoW: logo.w,
      logoH: logo.h
    };
    $("sizeVal").textContent = String(cfg.size);
    return cfg;
  }

  function show(){ sprite.style.opacity="1"; sprite.style.pointerEvents="auto"; sprite.style.display="block"; }
  function hide(){ sprite.style.opacity="0"; sprite.style.pointerEvents="none"; sprite.style.display="block"; }

  function applyAnim(el){
    el.style.setProperty("--dur", Math.max(0,cfg.dur)+"ms");
    el.classList.remove("anim-none","anim-pop","anim-fade","anim-soft","pulseHint");
    if(cfg.anim==="none") el.classList.add("anim-none");
    if(cfg.anim==="pop")  el.classList.add("anim-pop");
    if(cfg.anim==="fade") el.classList.add("anim-fade");
    if(cfg.anim==="soft") el.classList.add("anim-soft");
  }

  function updateUI(){
    readCfg();
    banner.textContent = cfg.task || "";
    count.textContent = `${found}/${cfg.rounds}`;
    sprite.style.width = cfg.size + "px";
    sprite.style.height = cfg.size + "px";
    applyAnim(sprite);
  }

  // ---- –≥–µ–æ–º–µ—Ç—Ä–∏—è (—É—á—ë—Ç —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–æ–≤/—Å–∫–µ–π–ª–∞) ----
  function stageInfo(container){
    const rr = container.getBoundingClientRect();
    const lw = container.clientWidth || container.offsetWidth || 1;
    const lh = container.clientHeight|| container.offsetHeight|| 1;
    const sx = (rr.width  / lw) || 1;
    const sy = (rr.height / lh) || 1;
    return {lw,lh,sx:(sx>0?sx:1),sy:(sy>0?sy:1), rr};
  }
  function elRectLayout(el, container, I){
    if(!el) return null;
    const r  = el.getBoundingClientRect();
    const xV = r.left - I.rr.left;
    const yV = r.top  - I.rr.top;
    return { x: xV / I.sx, y: yV / I.sy, w: r.width / I.sx, h: r.height / I.sy };
  }
  function intersects(a,b){
    return !(a.x + a.w <= b.x || a.x >= b.x + b.w || a.y + a.h <= b.y || a.y >= b.y + b.h);
  }
  function dist(a,b){ return Math.hypot(a.x-b.x,a.y-b.y); }

  function layoutReady(container){
    const rr = container.getBoundingClientRect();
    const w = (container.clientWidth || rr.width || 0);
    const h = (container.clientHeight|| rr.height|| 0);
    return (w>120 && h>120 && rr.width>120 && rr.height>120);
  }

  // ---- –ê–î–ê–ü–¢–ò–í–ù–´–ï –∑–∞–ø—Ä–µ—â—ë–Ω–Ω—ã–µ –∑–æ–Ω—ã (—á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–∫—Ä—ã–≤–∞–ª–∏ –ø–æ—á—Ç–∏ –≤—Å—ë –ø–æ–ª–µ) ----
  function buildForbiddenRects(container){
    const I = stageInfo(container);
    const s = Math.max(10, cfg.size||46);
    const half = s/2;

    const minSide = Math.max(1, Math.min(I.lw, I.lh));

    // –¥–µ–ª–∞–µ–º "edge" –Ω–µ –±–æ–ª—å—à–µ 12% –º–µ–Ω—å—à–µ–π —Å—Ç–æ—Ä–æ–Ω—ã
    const pad = clamp(cfg.pad||0, 0, 240);
    const edgeRaw = Math.max(pad, 18, Math.round(s*0.35));
    const edge = Math.min(edgeRaw, Math.round(minSide * 0.12));

    const padUI = Math.min(18, Math.round(minSide * 0.05));

    const rects = [];
    const b = elRectLayout(banner, container, I);
    const h = elRectLayout(hud, container, I);
    if(b) rects.push({x:b.x-padUI, y:b.y-padUI, w:b.w+padUI*2, h:b.h+padUI*2});
    if(h) rects.push({x:h.x-padUI, y:h.y-padUI, w:h.w+padUI*2, h:h.h+padUI*2});

    // —Å—Ç—Ä–µ–ª–∫–∏ (–æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–æ–ª–µ–π —à–∏—Ä–∏–Ω—ã/–≤—ã—Å–æ—Ç—ã)
    const aw = Math.min(clamp(cfg.arrowW||170, 60, 260), Math.round(I.lw * 0.32));
    const ah = Math.min(clamp(cfg.arrowH||320, 120, 420), Math.round(I.lh * 0.72));
    const arrowY = (I.lh - ah)/2;
    rects.push({x:-edge, y:arrowY-edge, w:aw+edge*2, h:ah+edge*2});
    rects.push({x:(I.lw-aw)-edge, y:arrowY-edge, w:aw+edge*2, h:ah+edge*2});

    // –ª–æ–≥–æ (–æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–æ–ª–µ–π —à–∏—Ä–∏–Ω—ã/–≤—ã—Å–æ—Ç—ã)
    const logoW = Math.min(clamp(cfg.logoW||200, 60, 360), Math.round(I.lw * 0.55));
    const logoH = Math.min(clamp(cfg.logoH||95,  40, 260), Math.round(I.lh * 0.28));
    rects.push({x:-edge, y:(I.lh-logoH)-edge, w:logoW+edge*2, h:logoH+edge*2});

    return {I, rects, edge, half, s};
  }

  function pickPosition(container){
    const {I, rects, edge, half, s} = buildForbiddenRects(container);

    const minX = edge + half;
    const minY = edge + half;
    const maxX = Math.max(minX, I.lw - edge - half);
    const maxY = Math.max(minY, I.lh - edge - half);

    const last = history[0] || null;
    const recent = history.slice(0,8);
    const minDist = Math.max(s*1.45, 64);

    function ok(x,y){
      const r = {x:x-half, y:y-half, w:s, h:s};
      for(const f of rects){ if(intersects(r,f)) return false; }
      return true;
    }

    const cand = [];
    const SAMPLES = 900, TOP_K = 20;

    for(let i=0;i<SAMPLES;i++){
      const x = minX + rand()*(maxX-minX);
      const y = minY + rand()*(maxY-minY);
      if(!ok(x,y)) continue;
      if(last && dist({x,y}, last) < minDist) continue;

      let d = 0;
      for(let k=0;k<recent.length;k++){
        d += dist({x,y}, recent[k]) * (k===0?1:0.35);
      }
      cand.push({x,y,sc:d + rand()*55});
    }

    let best;
    if(cand.length){
      cand.sort((a,b)=>b.sc-a.sc);
      const k = Math.min(TOP_K, cand.length);
      const idx = Math.floor(rand()*k);
      best = {x:cand[idx].x, y:cand[idx].y};
    }else{
      best = {x:(minX+maxX)/2, y:(minY+maxY)/2};
    }

    history.unshift(best);
    if(history.length > HISTORY_MAX) history.pop();
    return best;
  }

  function placeOnce(){
    if(!layoutReady(stage)) return false;
    const pt = pickPosition(stage);
    sprite.style.left = pt.x + "px";
    sprite.style.top  = pt.y + "px";
    sprite.style.transform = "translate(-50%,-50%) translateZ(0)";
    sprite.style.webkitTransform = "translate(-50%,-50%) translateZ(0)";
    lastGood = {x:pt.x, y:pt.y};
    return true;
  }

  // –±–æ–ª–µ–µ –¥–æ–ª–≥–∏–µ retries (Genially –∏–Ω–æ–≥–¥–∞ ‚Äú–¥–æ–≥—Ä—É–∂–∞–µ—Ç‚Äù —Ä–∞–∑–º–µ—Ä—ã –ø–æ–∑–¥–Ω–æ)
  function placeWithRetries(){
    const token = ++placeToken;
    const t0 = performance.now();

    show();
    if(lastGood.x!=null){
      sprite.style.left = lastGood.x + "px";
      sprite.style.top  = lastGood.y + "px";
    }else{
      sprite.style.left = "50%";
      sprite.style.top  = "55%";
    }

    const tick = ()=>{
      if(token !== placeToken) return;
      if(placeOnce()) return;
      if(performance.now() - t0 < 4500) setTimeout(tick, 16);
    };
    tick();
  }

  function multiReflowPlace(){
    placeWithRetries();
    setTimeout(placeWithRetries, 60);
    setTimeout(placeWithRetries, 160);
    setTimeout(placeWithRetries, 320);
    setTimeout(placeWithRetries, 650);
    setTimeout(placeWithRetries, 1100);
    setTimeout(placeWithRetries, 1700);
    setTimeout(placeWithRetries, 2400);
  }

  // === –∑–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ä—Ç–∏–Ω–∫–∏: —Ç–æ–ª—å–∫–æ Image preload ===
  function candidates(){
    const u = (cfg.imgUrl||"").trim();
    if(u) return [u];
    return DEFAULT_CANDIDATES.slice();
  }

  function loadImageSequential(list, timeoutMs){
    return new Promise((resolve)=>{
      let i=0, done=false;
      const timer=setTimeout(()=>{ if(done) return; done=true; resolve(false); }, Math.max(700, timeoutMs|0));
      const tryNext = ()=>{
        if(done) return;
        if(i>=list.length){
          clearTimeout(timer);
          done=true;
          resolve(false);
          return;
        }
        const raw=list[i++];
        const bust = raw + (raw.includes("?")?"&":"?") + "v=" + Date.now();
        const im = new Image();
        im.decoding="async";
        im.referrerPolicy="no-referrer";
        im.onload=()=>{ if(done) return; clearTimeout(timer); done=true; sprite.src=bust; resolve(true); };
        im.onerror=()=>tryNext();
        im.src=bust;
      };
      tryNext();
    });
  }

  async function ensureSpriteImage(){
    imgWarn.style.display="none";
    sprite.src = FALLBACK_SVG; // –≤—Å–µ–≥–¥–∞ –µ—Å—Ç—å —á—Ç–æ –ø–æ–∫–∞–∑–∞—Ç—å
    const ok = await loadImageSequential(candidates(), 2500);
    if(!ok){
      imgWarn.style.display="block";
      sprite.src = FALLBACK_SVG;
      return false;
    }
    return true;
  }

  function nextRound(){
    if(found >= cfg.rounds){
      banner.textContent = cfg.endText || "";
      hide();
      return;
    }
    applyAnim(sprite);
    placeWithRetries();
    count.textContent = `${found}/${cfg.rounds}`;
  }

  sprite.addEventListener("click", ()=>{
    found++;
    count.textContent = `${found}/${cfg.rounds}`;
    hide();

    setTimeout(()=>{
      if(found >= cfg.rounds){
        banner.textContent = cfg.endText || "";
        return;
      }
      show();
      nextRound();
    }, Math.max(0, cfg.pause|0));
  });

  lamp.addEventListener("click", ()=>{
    sprite.classList.remove("pulseHint");
    void sprite.offsetWidth;
    sprite.classList.add("pulseHint");
  });

  // UI events
  const inputs = ["imgUrl","size","rounds","pad","pause","anim","dur","task","endText","arrowW","arrowH","logoBox"];
  inputs.forEach(id=>{
    $(id).addEventListener("input", async ()=>{
      found=0; history=[]; lastGood={x:null,y:null};
      reseed("ui:"+id);
      updateUI();
      await ensureSpriteImage();
      show();
      multiReflowPlace();
      nextRound();
    });
  });

  $("btnReset").addEventListener("click", async ()=>{
    found=0; history=[]; lastGood={x:null,y:null};
    reseed("reset");
    updateUI();
    await ensureSpriteImage();
    show();
    multiReflowPlace();
    nextRound();
  });

  function buildGeniallyCode(){
    const c = readCfg();
    const cfgJson = JSON.stringify({
      imgUrl: c.imgUrl || "",
      base: BASE,
      size: c.size,
      rounds: c.rounds,
      pad: c.pad,
      pause: c.pause,
      anim: c.anim,
      dur: c.dur,
      task: c.task || "",
      endText: c.endText || "",
      arrowW: c.arrowW,
      arrowH: c.arrowH,
      logoW: c.logoW,
      logoH: c.logoH
    });

    return `<div id="FX_ROOT">
  <style>
    /* Genially-safe fullscreen: –Ω–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –≤—ã—Å–æ—Ç—ã —Ä–æ–¥–∏—Ç–µ–ª—è */
    #FX_ROOT{
      position:fixed; inset:0;
      width:100vw; height:100vh;
      min-width:100vw; min-height:100vh;
      overflow:hidden;
      background:transparent;
      font-family:system-ui,-apple-system,Segoe UI,Roboto;
      transform:translateZ(0);
      -webkit-transform:translateZ(0);
      z-index:2147483647;
      pointer-events:auto;
    }
    #FX_ROOT .topBanner{position:absolute;top:14px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.55);border:1px solid rgba(255,255,255,.12);border-radius:999px;padding:8px 14px;font-size:14px;color:rgba(255,255,255,.92);box-shadow:0 10px 30px rgba(0,0,0,.25);pointer-events:none;max-width:min(720px, calc(100% - 180px));text-align:center;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;z-index:2147483647;}
    #FX_ROOT .hud{position:absolute;top:14px;right:14px;display:flex;gap:10px;align-items:center;z-index:2147483647;}
    #FX_ROOT .lamp{width:38px;height:38px;border-radius:50%;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.14);display:grid;place-items:center;cursor:pointer;user-select:none;box-shadow:0 10px 30px rgba(0,0,0,.25);}
    #FX_ROOT .count{background:rgba(0,0,0,.45);border:1px solid rgba(255,255,255,.12);padding:6px 10px;border-radius:999px;font-size:13px;color:rgba(255,255,255,.92);min-width:52px;text-align:center;box-shadow:0 10px 30px rgba(0,0,0,.25);}
    #FX_ROOT .sprite{
      position:absolute;left:50%;top:55%;
      transform:translate(-50%,-50%) translateZ(0);
      -webkit-transform:translate(-50%,-50%) translateZ(0);
      backface-visibility:hidden;
      cursor:pointer;user-select:none;-webkit-user-drag:none;
      will-change:left,top,opacity,filter;
      z-index:2147483647;opacity:1;pointer-events:auto;
      transition:opacity 120ms ease;
    }
    #FX_ROOT .anim-none{opacity:1;}
    #FX_ROOT .anim-pop{animation:popIn var(--dur) ease-out both;}
    @keyframes popIn{from{transform:translate(-50%,-50%) scale(.6);opacity:0;}to{transform:translate(-50%,-50%) scale(1);opacity:1;}}
    #FX_ROOT .anim-fade{animation:fadeIn var(--dur) ease-out both;}
    @keyframes fadeIn{from{opacity:0;}to{opacity:1;}}
    #FX_ROOT .anim-soft{animation:softIn var(--dur) ease-out both;}
    @keyframes softIn{from{opacity:0;filter:blur(6px);}to{opacity:1;filter:blur(0);}}
    #FX_ROOT .pulseHint{animation:pulse 700ms ease-in-out 0s 3;}
    @keyframes pulse{0%,100%{transform:translate(-50%,-50%) scale(1);}50%{transform:translate(-50%,-50%) scale(1.15);}}
  </style>

  <div class="topBanner" id="fx_banner"></div>
  <div class="hud" id="fx_hud">
    <div class="lamp" id="fx_lamp" title="–ü–æ–¥—Å–∫–∞–∑–∫–∞">üí°</div>
    <div class="count" id="fx_count"></div>
  </div>
  <img class="sprite" id="fx_sprite" alt="sprite" draggable="false" />

  <scr` + `ipt>
  (function(){
    const root=document.getElementById('FX_ROOT');
    const banner=document.getElementById('fx_banner');
    const hud=document.getElementById('fx_hud');
    const count=document.getElementById('fx_count');
    const lamp=document.getElementById('fx_lamp');
    const sprite=document.getElementById('fx_sprite');
    const cfg=${cfgJson};

    const FALLBACK_SVG = "data:image/svg+xml;charset=utf-8," + encodeURIComponent(
      '<svg xmlns="http://www.w3.org/2000/svg" width="140" height="110" viewBox="0 0 140 110">' +
      '<path d="M70 62c-8-26-35-40-54-30-15 8-10 34 11 47 20 12 35 0 43-17z" fill="#7ee3ff"/>' +
      '<path d="M70 62c8-26 35-40 54-30 15 8 10 34-11 47-20 12-35 0-43-17z" fill="#7ee3ff"/>' +
      '<path d="M67 65c-2 11 2 25 2 25h6s4-14 2-25c-1-7-7-7-10 0z" fill="#0b1020"/>' +
      '<circle cx="70" cy="56" r="5" fill="#0b1020"/></svg>'
    );

    const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
    const intersects=(a,b)=>!(a.x+a.w<=b.x||a.x>=b.x+b.w||a.y+a.h<=b.y||a.y>=b.y+b.h);
    const dist=(a,b)=>Math.hypot(a.x-b.x,a.y-b.y);

    let SEED=0xA5A5A5A5>>>0;
    let GAME_COUNTER=0;
    function reseed(tag){
      GAME_COUNTER++;
      let r0=0,r1=0;
      try{
        const a=new Uint32Array(2);
        if(window.crypto&&crypto.getRandomValues){crypto.getRandomValues(a);r0=a[0]>>>0;r1=a[1]>>>0;}
        else{r0=(Math.random()*4294967296)>>>0;r1=(Date.now()>>>0)^((performance.now()*1000)>>>0);}
      }catch(e){r0=(Date.now()>>>0);r1=((performance.now()*1000)>>>0);}
      const mix=String(location.href||'')+'|'+String(tag||'')+'|'+String(GAME_COUNTER);
      let h=2166136261>>>0;for(let i=0;i<mix.length;i++){h^=mix.charCodeAt(i);h=Math.imul(h,16777619);}
      SEED=(r0^r1^h^(Date.now()>>>0)^(GAME_COUNTER>>>0))>>>0; if(SEED===0) SEED=0x9E3779B9;
    }
    function rand(){SEED^=(SEED<<13)>>>0;SEED^=(SEED>>>17)>>>0;SEED^=(SEED<<5)>>>0;return (SEED>>>0)/4294967296;}

    let found=0, history=[], lastGood={x:null,y:null}, placeToken=0;
    const HISTORY_MAX=18;

    function show(){sprite.style.opacity='1';sprite.style.pointerEvents='auto';sprite.style.display='block';}
    function hide(){sprite.style.opacity='0';sprite.style.pointerEvents='none';sprite.style.display='block';}

    function applyAnim(){
      sprite.style.setProperty('--dur', Math.max(0,cfg.dur||0)+'ms');
      sprite.classList.remove('anim-none','anim-pop','anim-fade','anim-soft','pulseHint');
      if(cfg.anim==='none') sprite.classList.add('anim-none');
      if(cfg.anim==='pop')  sprite.classList.add('anim-pop');
      if(cfg.anim==='fade') sprite.classList.add('anim-fade');
      if(cfg.anim==='soft') sprite.classList.add('anim-soft');
    }

    function stageInfo(){
      const rr=root.getBoundingClientRect();
      const lw=root.clientWidth||root.offsetWidth||1;
      const lh=root.clientHeight||root.offsetHeight||1;
      const sx=(rr.width/lw)||1, sy=(rr.height/lh)||1;
      return {lw,lh,sx:(sx>0?sx:1),sy:(sy>0?sy:1),rr};
    }
    function elRectLayout(el,I){
      if(!el) return null;
      const r=el.getBoundingClientRect();
      const xV=r.left-I.rr.left, yV=r.top-I.rr.top;
      return {x:xV/I.sx,y:yV/I.sy,w:r.width/I.sx,h:r.height/I.sy};
    }
    function layoutReady(){
      const rr=root.getBoundingClientRect();
      const w=(root.clientWidth||rr.width||0), h=(root.clientHeight||rr.height||0);
      return (w>140&&h>140&&rr.width>140&&rr.height>140);
    }

    function buildForbiddenRects(){
      const I=stageInfo();
      const s=Math.max(10,cfg.size||46), half=s/2;
      const minSide=Math.max(1, Math.min(I.lw,I.lh));

      const pad=clamp(cfg.pad||0,0,240);
      const edgeRaw=Math.max(pad,18,Math.round(s*0.35));
      const edge=Math.min(edgeRaw, Math.round(minSide*0.12));
      const padUI=Math.min(18, Math.round(minSide*0.05));

      const rects=[];
      const b=elRectLayout(banner, I);
      const h=elRectLayout(hud, I);
      if(b) rects.push({x:b.x-padUI,y:b.y-padUI,w:b.w+padUI*2,h:b.h+padUI*2});
      if(h) rects.push({x:h.x-padUI,y:h.y-padUI,w:h.w+padUI*2,h:h.h+padUI*2});

      const aw=Math.min(clamp(cfg.arrowW||170,60,260), Math.round(I.lw*0.32));
      const ah=Math.min(clamp(cfg.arrowH||320,120,420), Math.round(I.lh*0.72));
      const arrowY=(I.lh-ah)/2;
      rects.push({x:-edge,y:arrowY-edge,w:aw+edge*2,h:ah+edge*2});
      rects.push({x:(I.lw-aw)-edge,y:arrowY-edge,w:aw+edge*2,h:ah+edge*2});

      const logoW=Math.min(clamp(cfg.logoW||200,60,360), Math.round(I.lw*0.55));
      const logoH=Math.min(clamp(cfg.logoH||95,40,260), Math.round(I.lh*0.28));
      rects.push({x:-edge,y:(I.lh-logoH)-edge,w:logoW+edge*2,h:logoH+edge*2});

      return {I,rects,edge,half,s};
    }

    function pickPosition(){
      const {I,rects,edge,half,s}=buildForbiddenRects();
      const minX=edge+half, minY=edge+half;
      const maxX=Math.max(minX, I.lw-edge-half);
      const maxY=Math.max(minY, I.lh-edge-half);

      const last=history[0]||null;
      const recent=history.slice(0,8);
      const minDist=Math.max(s*1.45,64);

      function ok(x,y){
        const r={x:x-half,y:y-half,w:s,h:s};
        for(const f of rects) if(intersects(r,f)) return false;
        return true;
      }

      const cand=[];
      const SAMPLES=900, TOP_K=20;
      for(let i=0;i<SAMPLES;i++){
        const x=minX+rand()*(maxX-minX);
        const y=minY+rand()*(maxY-minY);
        if(!ok(x,y)) continue;
        if(last && dist({x,y},last)<minDist) continue;

        let d=0;
        for(let k=0;k<recent.length;k++) d += dist({x,y}, recent[k])*(k===0?1:0.35);
        cand.push({x,y,sc:d+rand()*55});
      }

      let best;
      if(cand.length){
        cand.sort((a,b)=>b.sc-a.sc);
        const k=Math.min(TOP_K,cand.length);
        const idx=Math.floor(rand()*k);
        best={x:cand[idx].x,y:cand[idx].y};
      }else{
        best={x:(minX+maxX)/2,y:(minY+maxY)/2};
      }

      history.unshift(best);
      if(history.length>HISTORY_MAX) history.pop();
      return best;
    }

    function placeOnce(){
      if(!layoutReady()) return false;
      const pt=pickPosition();
      sprite.style.left=pt.x+'px';
      sprite.style.top =pt.y+'px';
      sprite.style.transform='translate(-50%,-50%) translateZ(0)';
      sprite.style.webkitTransform='translate(-50%,-50%) translateZ(0)';
      lastGood={x:pt.x,y:pt.y};
      return true;
    }

    function placeWithRetries(){
      const token=++placeToken;
      const t0=performance.now();
      show();

      if(lastGood.x!=null){
        sprite.style.left=lastGood.x+'px';
        sprite.style.top =lastGood.y+'px';
      }else{
        sprite.style.left='50%';
        sprite.style.top ='55%';
      }

      const tick=()=>{
        if(token!==placeToken) return;
        if(placeOnce()) return;
        if(performance.now()-t0<4500) setTimeout(tick,16);
      };
      tick();
    }

    function reflowBurst(){
      placeWithRetries();
      setTimeout(placeWithRetries, 60);
      setTimeout(placeWithRetries, 160);
      setTimeout(placeWithRetries, 320);
      setTimeout(placeWithRetries, 650);
      setTimeout(placeWithRetries, 1100);
      setTimeout(placeWithRetries, 1700);
      setTimeout(placeWithRetries, 2400);
    }

    function setTexts(){
      banner.textContent=cfg.task||'';
      count.textContent=found+'/'+(cfg.rounds||7);
    }
    function setSize(){
      sprite.style.width=(cfg.size||46)+'px';
      sprite.style.height=(cfg.size||46)+'px';
    }

    function candidates(){
      const u=(cfg.imgUrl||'').trim();
      if(u) return [u];
      const base=(cfg.base||'').trim();
      return [base+'babushka_2.png',base+'babushka_2.webp',base+'babushka_2.svg',base+'babushka_2.jpg',base+'babushka_2'];
    }

    function loadImageSequential(list, timeoutMs){
      return new Promise((resolve)=>{
        let i=0, done=false;
        const timer=setTimeout(()=>{ if(done) return; done=true; resolve(false); }, Math.max(700, timeoutMs|0));
        const tryNext=()=>{
          if(done) return;
          if(i>=list.length){ clearTimeout(timer); done=true; resolve(false); return; }
          const raw=list[i++];
          const bust=raw + (raw.includes('?')?'&':'?') + 'v=' + Date.now();
          const im=new Image();
          im.decoding='async';
          im.referrerPolicy='no-referrer';
          im.onload=()=>{ if(done) return; clearTimeout(timer); done=true; sprite.src=bust; resolve(true); };
          im.onerror=()=>tryNext();
          im.src=bust;
        };
        tryNext();
      });
    }

    async function ensureImg(){
      sprite.src = FALLBACK_SVG;
      const ok = await loadImageSequential(candidates(), 2600);
      if(!ok){ sprite.src = FALLBACK_SVG; }
    }

    function nextRound(){
      if(found >= (cfg.rounds||7)){
        banner.textContent = cfg.endText || '';
        hide();
        return;
      }
      applyAnim();
      placeWithRetries();
      setTexts();
    }

    sprite.addEventListener('click', ()=>{
      found++;
      setTexts();
      hide();
      setTimeout(()=>{
        if(found >= (cfg.rounds||7)){
          banner.textContent = cfg.endText || '';
          return;
        }
        show();
        nextRound();
      }, Math.max(0, cfg.pause||0));
    });

    lamp.addEventListener('click', ()=>{
      sprite.classList.remove('pulseHint'); void sprite.offsetWidth; sprite.classList.add('pulseHint');
    });

    // —Å—Ç–∞—Ä—Ç
    reseed('game-start');
    setSize(); applyAnim(); setTexts();
    ensureImg().then(()=>{ show(); reflowBurst(); nextRound(); });

    if('ResizeObserver' in window){
      const ro=new ResizeObserver(()=>reflowBurst());
      ro.observe(root);
    }
    window.addEventListener('resize', ()=>reflowBurst(), {passive:true});
    window.addEventListener('orientationchange', ()=>reflowBurst(), {passive:true});
    document.addEventListener('fullscreenchange', ()=>reflowBurst());
    document.addEventListener('webkitfullscreenchange', ()=>reflowBurst());
    document.addEventListener('visibilitychange', ()=>{ if(!document.hidden){ reseed('resume'); reflowBurst(); }});
    if(window.visualViewport){
      window.visualViewport.addEventListener('resize', ()=>reflowBurst(), {passive:true});
    }
  })();
  <\\/scr` + `ipt>
</div>`;
  }

  async function copyText(text){
    try{ await navigator.clipboard.writeText(text); return true; }
    catch(e){
      const ta=document.createElement("textarea");
      ta.value=text; ta.style.position="fixed"; ta.style.left="-9999px";
      document.body.appendChild(ta); ta.select();
      const ok=document.execCommand("copy");
      document.body.removeChild(ta);
      return ok;
    }
  }

  $("btnCode").addEventListener("click", ()=>{
    out.value = buildGeniallyCode();
    out.scrollTop = 0;
  });

  $("btnCopy").addEventListener("click", async ()=>{
    if(!out.value.trim()) out.value = buildGeniallyCode();
    await copyText(out.value);
  });

  async function init(){
    found=0; history=[]; lastGood={x:null,y:null};
    reseed("init");
    updateUI();
    await ensureSpriteImage();
    show();
    multiReflowPlace();
    nextRound();
  }

  // editor resize hooks
  if('ResizeObserver' in window){
    const ro = new ResizeObserver(()=>multiReflowPlace());
    ro.observe(stage);
  }
  window.addEventListener("resize", ()=>multiReflowPlace(), {passive:true});
  window.addEventListener("orientationchange", ()=>multiReflowPlace(), {passive:true});
  document.addEventListener("fullscreenchange", ()=>multiReflowPlace());
  document.addEventListener("webkitfullscreenchange", ()=>multiReflowPlace());
  document.addEventListener("visibilitychange", ()=>{ if(!document.hidden){ reseed("resume"); multiReflowPlace(); } });
  if(window.visualViewport){
    window.visualViewport.addEventListener("resize", ()=>multiReflowPlace(), {passive:true});
  }

  init();
})();
</script>
</body>
</html>
