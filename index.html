<div id="FX_ROOT">
  <style>
    #FX_ROOT{
      position:relative !important;
      width:100% !important;
      height:100% !important;
      min-width:100% !important;
      min-height:100% !important;
      overflow:hidden !important;
      background:transparent !important;
    }
    /* –í–ê–ñ–ù–û: –µ—Å–ª–∏ Genially –∑–∞–≤–æ—Ä–∞—á–∏–≤–∞–µ—Ç –≤–Ω—É—Ç—Ä—å ‚Äî —Ä–∞—Å—Ç—è–≥–∏–≤–∞–µ–º –≤—Å—ë —á—Ç–æ –º–æ–∂–Ω–æ */
    #FX_ROOT, #FX_ROOT *{ box-sizing:border-box; }

    .fx_prog{
      position:absolute; right:14px; top:14px; z-index:999999;
      background:rgba(0,0,0,.45); border:1px solid rgba(255,255,255,.18);
      padding:6px 10px; border-radius:999px; font-size:12px; color:rgba(255,255,255,.9);
      backdrop-filter: blur(6px);
      pointer-events:none; user-select:none;
    }
    .fx_hintBtn{
      position:absolute; right:64px; top:12px; z-index:1000000;
      width:38px; height:38px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(0,0,0,.35);
      color:rgba(255,255,255,.92);
      font-size:18px;
      cursor:pointer;
      display:flex; align-items:center; justify-content:center;
      backdrop-filter: blur(6px);
      box-shadow: 0 12px 30px rgba(0,0,0,.18);
      -webkit-tap-highlight-color: transparent;
      user-select:none;
    }
    .fx_task{
      position:absolute; left:50%; top:18px; transform:translateX(-50%);
      z-index:999998;
      max-width:min(720px, calc(100% - 40px));
      background:rgba(0,0,0,.42);
      border:1px solid rgba(255,255,255,.18);
      border-radius:14px;
      padding:10px 14px;
      color:rgba(255,255,255,.95);
      font:700 14px/1.25 system-ui,-apple-system,Segoe UI,Roboto,Arial;
      text-align:center;
      backdrop-filter: blur(8px);
      pointer-events:none; user-select:none;
      box-shadow: 0 12px 30px rgba(0,0,0,.22);
    }
    .fx_target{ position:absolute; z-index:999999; cursor:pointer; user-select:none; -webkit-tap-highlight-color: transparent; }
    .fx_target img{display:block;width:100%;height:100%;object-fit:contain}

    @keyframes fxHintPulse{
      0%{transform:scale(1);opacity:1;filter:drop-shadow(0 0 0 rgba(120,220,255,0));}
      20%{transform:scale(1.25);opacity:1;filter:drop-shadow(0 0 14px rgba(120,220,255,.95));}
      40%{transform:scale(1);opacity:.35;filter:drop-shadow(0 0 0 rgba(120,220,255,0));}
      60%{transform:scale(1.25);opacity:1;filter:drop-shadow(0 0 16px rgba(120,220,255,.98));}
      80%{transform:scale(1);opacity:.35;filter:drop-shadow(0 0 0 rgba(120,220,255,0));}
      100%{transform:scale(1);opacity:1;filter:drop-shadow(0 0 0 rgba(120,220,255,0));}
    }
    .fx_target.fx-hint img{ animation: fxHintPulse 900ms ease-in-out 0s 2; }
  </style>

  <div class="fx_prog">0/7</div>
  <button class="fx_hintBtn" type="button" aria-label="–ü–æ–¥—Å–∫–∞–∑–∫–∞" title="–ü–æ–¥—Å–∫–∞–∑–∫–∞">üí°</button>
  <div class="fx_task">–ù–∞–π–¥–∏ –±–∞–±–æ—á–∫—É –∏ –Ω–∞–∂–º–∏ –Ω–∞ –Ω–µ—ë!</div>
  <div class="fx_target"><img alt=""></div>

  <script>
  (function(){
    const root = document.getElementById('FX_ROOT');
    const progEl = root.querySelector('.fx_prog');
    const hintBtn = root.querySelector('.fx_hintBtn');
    const taskEl = root.querySelector('.fx_task');
    const target = root.querySelector('.fx_target');
    const img = target.querySelector('img');

    const cfg = {
      url: "https://propodgotovkaa-creator.github.io/babochka_2/babushka_2?img=1",
      size: 46,
      rounds: 7,
      task: "–ù–∞–π–¥–∏ –±–∞–±–æ—á–∫—É –∏ –Ω–∞–∂–º–∏ –Ω–∞ –Ω–µ—ë!",
      pad: 12,
      gap: 200
    };

    let found = 0;
    let last = {x:null,y:null};
    const history = [];
    const HISTORY_MAX = 14;

    function clamp(n,a,b){ return Math.max(a, Math.min(b,n)); }
    function rect(){
      const r = root.getBoundingClientRect();
      return {w: Math.max(1, r.width), h: Math.max(1, r.height)};
    }
    function intersects(a, b){
      return !(a.x + a.w <= b.x || b.x + b.w <= a.x || a.y + a.h <= b.y || b.y + b.h <= a.y);
    }
    function toRootRect(el){
      const sr = root.getBoundingClientRect();
      const r = el.getBoundingClientRect();
      return { x: r.left - sr.left, y: r.top - sr.top, w: r.width, h: r.height };
    }
    function pushHistory(pt){
      history.push({x:pt.x,y:pt.y});
      if(history.length>HISTORY_MAX) history.shift();
    }
    function distanceToHistory(pt){
      if(!history.length) return Infinity;
      let m=Infinity;
      for(const p of history) m=Math.min(m, Math.hypot(pt.x-p.x, pt.y-p.y));
      return m;
    }

    function getForbiddenRects(){
      const rects = [];
      const padUI = 10;

      for(const el of [taskEl, progEl, hintBtn]){
        const r = toRootRect(el);
        rects.push({ x:r.x-padUI, y:r.y-padUI, w:r.w+padUI*2, h:r.h+padUI*2 });
      }

      const {w,h} = rect();

      // –ª–æ–≥–æ—Ç–∏–ø Genially (—Å–ª–µ–≤–∞ —Å–Ω–∏–∑—É)
      rects.push({ x:0, y:h-78, w:200, h:78 });

      // –ø—è—Ç–Ω–æ —Å—Ç—Ä–µ–ª–∫–∏ —Å–ø—Ä–∞–≤–∞ –ø–æ —Ü–µ–Ω—Ç—Ä—É
      rects.push({ x:w-90, y:(h-160)/2, w:90, h:160 });

      return rects;
    }

    function randomPos(){
      const {w,h} = rect();
      const s = Math.max(1, cfg.size|0);
      const p = clamp(cfg.pad|0, 0, 240);
      const forbid = getForbiddenRects();
      const candidateRect = (pt)=>({x:pt.x,y:pt.y,w:s,h:s});

      // –µ—Å–ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å–ª–∏—à–∫–æ–º –º–∞–ª–µ–Ω—å–∫–∏–π ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –±–µ–∑–æ–ø–∞—Å–Ω–æ
      if(w < s + p*2 + 10 || h < s + p*2 + 10){
        return {x:p, y:p};
      }

      const cols=4, rows=3;
      const cellW=w/cols, cellH=h/rows;

      const cellUse = new Array(cols*rows).fill(0);
      for(const pt of history){
        const cx = Math.min(cols-1, Math.max(0, Math.floor(pt.x/cellW)));
        const cy = Math.min(rows-1, Math.max(0, Math.floor(pt.y/cellH)));
        cellUse[cy*cols+cx]++;
      }
      const order=[...cellUse.keys()].sort((a,b)=>cellUse[a]-cellUse[b]);

      function tryInCell(idx, tries){
        const cx=idx%cols, cy=Math.floor(idx/cols);
        const minX=Math.max(p, cx*cellW+p);
        const maxX=Math.min(w-p-s, (cx+1)*cellW-p-s);
        const minY=Math.max(p, cy*cellH+p);
        const maxY=Math.min(h-p-s, (cy+1)*cellH-p-s);
        if(maxX<=minX || maxY<=minY) return null;

        let best=null, bestScore=-1;
        for(let i=0;i<tries;i++){
          const pt={x:minX+Math.random()*(maxX-minX), y:minY+Math.random()*(maxY-minY)};
          const cr=candidateRect(pt);
          if(forbid.some(fr=>intersects(cr,fr))) continue;

          const dHist=distanceToHistory(pt);
          const dLast=(last.x===null)?dHist:Math.hypot(pt.x-last.x, pt.y-last.y);
          const score=dHist*1.05 + dLast*0.35 + Math.random()*12;
          if(score>bestScore){bestScore=score; best=pt;}
        }
        return best;
      }

      let best=null;
      for(const idx of order){
        best = tryInCell(idx, 55);
        if(best) break;
      }
      if(!best){
        const minX=p, minY=p, maxX=w-p-s, maxY=h-p-s;
        for(let k=0;k<200;k++){
          const pt={x:minX+Math.random()*(maxX-minX), y:minY+Math.random()*(maxY-minY)};
          const cr=candidateRect(pt);
          if(!forbid.some(fr=>intersects(cr,fr))){ best=pt; break; }
        }
        if(!best) best={x:minX,y:minY};
      }

      last=best; pushHistory(best);
      return best;
    }

    function place(){
      target.style.width = (cfg.size|0) + "px";
      target.style.height = (cfg.size|0) + "px";
      const pos = randomPos();
      target.style.left = pos.x + "px";
      target.style.top  = pos.y + "px";
    }

    function updateUI(){
      progEl.textContent = found + "/" + (cfg.rounds|0);
      taskEl.textContent = cfg.task;
    }

    function next(){
      updateUI();
      place();
      target.style.display = "";
    }

    hintBtn.addEventListener('click', ()=>{
      target.classList.remove('fx-hint');
      void target.offsetWidth;
      target.classList.add('fx-hint');
      setTimeout(()=>target.classList.remove('fx-hint'), 1800);
    });

    target.addEventListener('click', ()=>{
      found++;
      if(found >= (cfg.rounds|0)){
        updateUI();
        target.style.display="none";
        return;
      }
      updateUI();
      target.style.display="none";
      setTimeout(()=>{ next(); }, Math.max(0, cfg.gap|0));
    });

    // –≤–∞–∂–Ω–æ: Genially –º–æ–∂–µ—Ç –º–µ–Ω—è—Ç—å —Ä–∞–∑–º–µ—Ä –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
    const ro = ('ResizeObserver' in window) ? new ResizeObserver(()=>{ place(); }) : null;
    if(ro) ro.observe(root);
    window.addEventListener('resize', place, {passive:true});

    img.referrerPolicy = "no-referrer";
    img.src = cfg.url;

    // —Å—Ç–∞—Ä—Ç —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –ø–µ—Ä–µ—Å—á—ë—Ç–∞–º–∏
    updateUI();
    next();
    setTimeout(place, 250);
    setTimeout(place, 900);
  })();
  </script>
</div>
