<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,height=device-height,initial-scale=1.0" />
<title>–†–µ–¥–∞–∫—Ç–æ—Ä ¬´–ù–∞–π–¥–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞¬ª</title>
<style>
  :root{
    --bg1:#0b1020;
    --panel:rgba(20,24,40,.75);
    --stroke:rgba(255,255,255,.10);
    --txt:rgba(255,255,255,.92);
    --muted:rgba(255,255,255,.65);
    --btn:#2d6cff;
    --ok:#22c55e;
  }
  html,body{margin:0;height:100%;background:var(--bg1);font-family:system-ui,-apple-system,Segoe UI,Roboto; color:var(--txt); overflow:hidden;}
  .app{position:fixed; inset:0; display:grid; grid-template-columns: 380px 1fr; gap:14px; padding:14px; box-sizing:border-box;}
  @media (max-width: 980px){ .app{grid-template-columns:1fr; grid-template-rows:auto 1fr;} }
  .panel{background:var(--panel); border:1px solid var(--stroke); border-radius:18px; padding:14px 14px 12px; overflow:auto; backdrop-filter: blur(10px);}
  .title{font-size:18px; font-weight:700; margin:0 0 8px;}
  .desc{font-size:12px; color:var(--muted); line-height:1.35; margin:0 0 12px;}
  .field{margin:10px 0;}
  label{display:block;font-size:12px;color:var(--muted); margin:0 0 4px;}
  input,select,textarea{width:100%; box-sizing:border-box; background:#101a36; border:1px solid rgba(255,255,255,.10); color:var(--txt); border-radius:10px; padding:8px 10px; outline:none;}
  input[type="range"]{padding:0; height:28px;}
  textarea{min-height:70px; resize:vertical;}
  .row{display:grid; grid-template-columns:1fr 1fr; gap:10px;}
  .btnRow{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;}
  button{border:none; border-radius:12px; padding:10px 12px; cursor:pointer; font-weight:700; color:white; background:rgba(255,255,255,.12);}
  button.primary{background:var(--btn);}
  button.success{background:var(--ok); color:#062012;}
  button.ghost{background:rgba(255,255,255,.10);}
  .codeBox{margin-top:10px; border:1px solid rgba(255,255,255,.10); border-radius:14px; background:rgba(0,0,0,.25); padding:10px;}
  .codeBox .cap{font-size:12px;color:var(--muted); margin:0 0 8px;}
  #out{width:100%; min-height:170px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; font-size:12px; line-height:1.35; white-space:pre;}
  .hint{margin-top:8px;font-size:12px;color:var(--muted);}
  .warn{margin-top:8px;font-size:12px;color:#ffd27a;display:none;}

  .stage{position:relative; border-radius:18px; overflow:hidden; border:1px solid var(--stroke);
    background:
      repeating-linear-gradient(135deg, rgba(255,255,255,.05) 0, rgba(255,255,255,.05) 8px, rgba(255,255,255,.02) 8px, rgba(255,255,255,.02) 16px),
      linear-gradient(180deg, rgba(15,24,50,.55), rgba(0,0,0,.25));
  }
  .topBanner{position:absolute; top:14px; left:50%; transform:translateX(-50%);
    background:rgba(0,0,0,.55); border:1px solid rgba(255,255,255,.12);
    border-radius:999px; padding:8px 14px; font-size:14px;
    box-shadow:0 10px 30px rgba(0,0,0,.25);
    pointer-events:none; max-width:min(720px, calc(100% - 180px));
    text-align:center; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; z-index:5;
  }
  .hud{position:absolute; top:14px; right:14px; display:flex; gap:10px; align-items:center; z-index:6;}
  .lamp{width:38px; height:38px; border-radius:50%; border:1px solid rgba(255,255,255,.14);
    background:rgba(255,255,255,.14); display:grid; place-items:center; cursor:pointer; user-select:none;
    box-shadow:0 10px 30px rgba(0,0,0,.25);
  }
  .lamp:active{transform:translateY(1px);}
  .count{background:rgba(0,0,0,.45); border:1px solid rgba(255,255,255,.12); padding:6px 10px; border-radius:999px;
    font-size:13px; min-width:52px; text-align:center; box-shadow:0 10px 30px rgba(0,0,0,.25);
  }
  .sprite{position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); cursor:pointer; user-select:none; -webkit-user-drag:none;
    will-change: transform, opacity, filter; z-index:4;
  }

  .anim-none{opacity:1;}
  .anim-pop{animation:popIn var(--dur) ease-out both;}
  @keyframes popIn{from{transform:translate(-50%,-50%) scale(.6); opacity:0;} to{transform:translate(-50%,-50%) scale(1); opacity:1;}}
  .anim-fade{animation:fadeIn var(--dur) ease-out both;}
  @keyframes fadeIn{from{opacity:0;} to{opacity:1;}}
  .anim-soft{animation:softIn var(--dur) ease-out both;}
  @keyframes softIn{from{opacity:0; filter:blur(6px);} to{opacity:1; filter:blur(0);}}
  .pulseHint{animation:pulse 700ms ease-in-out 0s 3;}
  @keyframes pulse{0%,100%{transform:translate(-50%,-50%) scale(1);}50%{transform:translate(-50%,-50%) scale(1.15);}}
</style>
</head>

<body>
<div class="app">
  <div class="panel">
    <div class="title">–†–µ–¥–∞–∫—Ç–æ—Ä ¬´–ù–∞–π–¥–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞¬ª</div>
    <p class="desc">–ù–∞—Å—Ç—Ä–æ–π –ø–∞—Ä–∞–º–µ—Ç—Ä—ã ‚Üí ¬´–ü–æ–ª—É—á–∏—Ç—å –∫–æ–¥¬ª ‚Üí –≤—Å—Ç–∞–≤—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ Genially (HTML/Embed).</p>

    <div class="field">
      <label>URL –∫–∞—Ä—Ç–∏–Ω–∫–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ (–º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –ø—É—Å—Ç—ã–º)</label>
      <input id="imgUrl" placeholder="https://.../image.png">
      <div class="hint">
        –ï—Å–ª–∏ –ø—É—Å—Ç–æ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è:
        <b>https://propodgotovkaa-creator.github.io/babochka_2/babushka_2</b> (+ .png/.webp/.jpg/.svg)
      </div>
      <div class="warn" id="imgWarn">‚ö†Ô∏è –ö–∞—Ä—Ç–∏–Ω–∫–∞ –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–∞—Å—å. –ü—Ä–æ–≤–µ—Ä—å URL/–∏–º—è —Ñ–∞–π–ª–∞ –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏.</div>
    </div>

    <div class="row">
      <div class="field">
        <label>–†–∞–∑–º–µ—Ä (px)</label>
        <input type="range" id="size" min="20" max="240" value="46">
        <div class="hint"><span id="sizeVal">46</span> px</div>
      </div>
      <div class="field">
        <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞—Ö–æ–¥–æ–∫ (—Ä–∞—É–Ω–¥–æ–≤)</label>
        <input type="number" id="rounds" min="1" max="99" value="8">
      </div>
    </div>

    <div class="row">
      <div class="field">
        <label>–û—Ç—Å—Ç—É–ø –æ—Ç –∫—Ä–∞—ë–≤ (px)</label>
        <input type="number" id="pad" min="0" max="240" value="12">
      </div>
      <div class="field">
        <label>–ü–∞—É–∑–∞ –º–µ–∂–¥—É —Ä–∞—É–Ω–¥–∞–º–∏ (–º—Å)</label>
        <input type="number" id="pause" min="0" max="8000" value="200">
      </div>
    </div>

    <div class="row">
      <div class="field">
        <label>–ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è</label>
        <select id="anim">
          <option value="soft" selected>soft fade (–º–µ–¥–ª–µ–Ω–Ω–æ)</option>
          <option value="fade">fade</option>
          <option value="pop">pop</option>
          <option value="none">–±–µ–∑ –∞–Ω–∏–º–∞—Ü–∏–∏</option>
        </select>
      </div>
      <div class="field">
        <label>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∞–Ω–∏–º–∞—Ü–∏–∏ (–º—Å)</label>
        <input type="number" id="dur" min="0" max="5000" value="1100">
      </div>
    </div>

    <div class="field">
      <label>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è (–ø–ª–∞—à–∫–∞ —Å–≤–µ—Ä—Ö—É –ø–æ —Ü–µ–Ω—Ç—Ä—É)</label>
      <input id="task" value="–ù–∞–π–¥–∏ –±–∞–±–æ—á–∫—É –∏ –Ω–∞–∂–º–∏ –Ω–∞ –Ω–µ—ë!">
    </div>

    <div class="field">
      <label>–¢–µ–∫—Å—Ç –≤ –∫–æ–Ω—Ü–µ –∏–≥—Ä—ã</label>
      <textarea id="endText">–ú–æ–ª–æ–¥–µ—Ü! –ü—Ä–∏—Ö–æ–¥–∏ –∏–≥—Ä–∞—Ç—å –µ—â—ë —Ä–∞–∑ üòä</textarea>
    </div>

    <div class="row">
      <div class="field">
        <label>–ó–æ–Ω–∞ —Å—Ç—Ä–µ–ª–æ–∫ —Å–ª–µ–≤–∞/—Å–ø—Ä–∞–≤–∞ (px)</label>
        <input type="number" id="arrowW" min="60" max="320" value="120">
      </div>
      <div class="field">
        <label>–í—ã—Å–æ—Ç–∞ –∑–æ–Ω—ã —Å—Ç—Ä–µ–ª–æ–∫ (px)</label>
        <input type="number" id="arrowH" min="120" max="560" value="220">
      </div>
    </div>

    <div class="row">
      <div class="field">
        <label>–õ–æ–≥–æ Genially —Å–ª–µ–≤–∞ —Å–Ω–∏–∑—É (w√óh, px)</label>
        <input type="text" id="logoBox" value="170x120">
        <div class="hint">–§–æ—Ä–º–∞—Ç: 170x120</div>
      </div>
      <div class="field">
        <label>&nbsp;</label>
        <div class="hint">Fix –¥–ª—è fullscreen: —Ä–∞—Å—á—ë—Ç –≤ scaled-–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞—Ö + –ø–µ—Ä–µ–≤–æ–¥ –≤ layout.</div>
      </div>
    </div>

    <div class="btnRow">
      <button class="primary" id="btnCode">–ü–æ–ª—É—á–∏—Ç—å –∫–æ–¥</button>
      <button class="success" id="btnCopy">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥</button>
      <button class="ghost" id="btnReset">–°–±—Ä–æ—Å</button>
    </div>

    <div class="codeBox">
      <div class="cap">HTML-–∫–æ–¥ –¥–ª—è Genially (DIV + STYLE + SCRIPT)</div>
      <textarea id="out" readonly placeholder="–ù–∞–∂–º–∏ ¬´–ü–æ–ª—É—á–∏—Ç—å –∫–æ–¥¬ª"></textarea>
    </div>
  </div>

  <div class="stage" id="stage">
    <div class="topBanner" id="banner">–ù–∞–π–¥–∏ –±–∞–±–æ—á–∫—É –∏ –Ω–∞–∂–º–∏ –Ω–∞ –Ω–µ—ë!</div>
    <div class="hud">
      <div class="lamp" id="lamp" title="–ü–æ–¥—Å–∫–∞–∑–∫–∞">üí°</div>
      <div class="count" id="count">0/8</div>
    </div>
    <img class="sprite" id="sprite" alt="sprite" />
  </div>
</div>

<script>
(() => {
  const $ = (id)=>document.getElementById(id);
  const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
  const parseBox=(s,defW,defH)=>{
    const m = String(s||"").toLowerCase().match(/(\d+)\s*x\s*(\d+)/);
    if(!m) return {w:defW,h:defH};
    return {w:+m[1],h:+m[2]};
  };

  const DEFAULT_BASE = "https://propodgotovkaa-creator.github.io/babochka_2/babushka_2";

  const stage = $("stage");
  const sprite = $("sprite");
  const banner = $("banner");
  const count  = $("count");
  const lamp   = $("lamp");
  const imgWarn = $("imgWarn");

  let cfg = {};
  let found = 0;

  // ---------- shared random core (CENTER coords) ----------
  let history = [];
  const HISTORY_MAX = 14;
  let cellCounts = new Map();
  let lastCell = null;

  const dist=(a,b)=>Math.hypot(a.x-b.x, a.y-b.y);
  const intersects=(a,b)=>!(a.x + a.w <= b.x || a.x >= b.x + b.w || a.y + a.h <= b.y || a.y >= b.y + b.h);

  function readCfg(){
    const logo = parseBox($("logoBox").value, 170, 120);
    cfg = {
      imgUrl: $("imgUrl").value.trim(),
      defaultBase: DEFAULT_BASE,
      size: +$("size").value,
      rounds: +$("rounds").value,
      pad: +$("pad").value,
      pause: +$("pause").value,
      anim: $("anim").value,
      dur: +$("dur").value,
      task: $("task").value,
      endText: $("endText").value,
      arrowW: +$("arrowW").value,
      arrowH: +$("arrowH").value,
      logoW: logo.w,
      logoH: logo.h
    };
    $("sizeVal").textContent = String(cfg.size);
    return cfg;
  }

  function applyAnim(){
    sprite.style.setProperty("--dur", Math.max(0,cfg.dur)+"ms");
    sprite.classList.remove("anim-none","anim-pop","anim-fade","anim-soft");
    if(cfg.anim==="none") sprite.classList.add("anim-none");
    if(cfg.anim==="pop")  sprite.classList.add("anim-pop");
    if(cfg.anim==="fade") sprite.classList.add("anim-fade");
    if(cfg.anim==="soft") sprite.classList.add("anim-soft");
  }
  function setSpriteSize(){
    sprite.style.width = cfg.size + "px";
    sprite.style.height = cfg.size + "px";
  }

  function updateUI(){
    readCfg();
    banner.textContent = cfg.task || "";
    count.textContent = `${found}/${cfg.rounds}`;
    setSpriteSize();
    applyAnim();
  }

  // ---------- image load ----------
  async function tryLoadFetch(url){
    try{
      const bust = url + (url.includes("?") ? "&" : "?") + "v=" + Date.now();
      const res = await fetch(bust, {cache:"no-store"});
      if(!res.ok) return null;
      const blob = await res.blob();
      if(!blob || blob.size < 10) return null;
      return URL.createObjectURL(blob);
    }catch(e){ return null; }
  }
  function candidates(){
    const u = (cfg.imgUrl||"").trim();
    if(u) return [u];
    const base = (cfg.defaultBase||DEFAULT_BASE).trim();
    return [base, base+".png", base+".webp", base+".jpg", base+".svg"];
  }
  async function setSpriteSource(){
    imgWarn.style.display = "none";
    if(sprite.dataset.objurl){
      try{ URL.revokeObjectURL(sprite.dataset.objurl); }catch(e){}
      sprite.dataset.objurl = "";
    }
    for(const u of candidates()){
      const obj = await tryLoadFetch(u);
      if(obj){
        sprite.src = obj;
        sprite.dataset.objurl = obj;
        return true;
      }
    }
    sprite.removeAttribute("src");
    imgWarn.style.display = "block";
    return false;
  }

  // ---------- PREVIEW positioning (no genially scale here) ----------
  function stageWH(){
    const w = stage.clientWidth || stage.offsetWidth || 1;
    const h = stage.clientHeight || stage.offsetHeight || 1;
    return {w:Math.max(1,w), h:Math.max(1,h)};
  }

  function buildForbiddenRects(w,h,p,logoW,logoH,arrowW,arrowH){
    const bannerH=92, bannerW=Math.min(760, w-220), bannerX=(w-bannerW)/2;
    const logoX=0, logoY=h-logoH;
    const aw=clamp(arrowW,60,320), ah=clamp(arrowH,120,560), arrowY=(h-ah)/2;
    const hudW=120, hudH=70, hudX=w-hudW, hudY=0;
    const padRect=(r)=>({x:r.x-p,y:r.y-p,w:r.w+p*2,h:r.h+p*2});
    return [
      padRect({x:bannerX,y:0,w:bannerW,h:bannerH}),
      padRect({x:logoX,y:logoY,w:logoW,h:logoH}),
      padRect({x:0,y:arrowY,w:aw,h:ah}),
      padRect({x:w-aw,y:arrowY,w:aw,h:ah}),
      padRect({x:hudX,y:hudY,w:hudW,h:hudH}),
    ];
  }

  function pushHistory(pt){
    history.unshift(pt);
    if(history.length>HISTORY_MAX) history.pop();
  }

  function pickPosition_inSpace(spaceW, spaceH){
    const s = Math.max(10, cfg.size);
    const p = clamp(cfg.pad, 0, 240);
    const half=s/2;

    const minX=p+half, minY=p+half;
    const maxX=Math.max(minX, spaceW-p-half);
    const maxY=Math.max(minY, spaceH-p-half);

    const forbid = buildForbiddenRects(spaceW, spaceH, p, cfg.logoW, cfg.logoH, cfg.arrowW, cfg.arrowH);
    const cols=6, rows=5, cellW=spaceW/cols, cellH=spaceH/rows;

    const lastPt = history[0] || null;
    const recent = history.slice(0,7);

    const key=(cx,cy)=>cx+','+cy;
    const getCount=(k)=>cellCounts.get(k)||0;

    function okCenter(x,y){
      const r={x:x-half,y:y-half,w:s,h:s};
      for(const f of forbid) if(intersects(r,f)) return false;
      return true;
    }

    const cells=[];
    for(let cy=0;cy<rows;cy++) for(let cx=0;cx<cols;cx++){
      const k=key(cx,cy);
      const center={x:cx*cellW+cellW/2,y:cy*cellH+cellH/2};
      const rarity = 220/(1+getCount(k));
      const dLast = lastPt ? dist(center,lastPt) : 220;
      let dRecent=0; for(const rp of recent) dRecent += dist(center,rp);
      dRecent = recent.length ? dRecent/recent.length : 0;
      const repeatPenalty = (k===lastCell) ? 320 : 0;
      const score = rarity + dLast*1.05 + dRecent*0.35 + Math.random()*140 - repeatPenalty;
      cells.push({cx,cy,k,score});
    }
    cells.sort((a,b)=>b.score-a.score);

    const TOPK=Math.min(12,cells.length);
    const pool=cells.slice(0,TOPK);
    let sum=0; for(const c of pool) sum+=Math.max(1,c.score);
    let r=Math.random()*sum;
    let chosen=pool[0];
    for(const c of pool){ r-=Math.max(1,c.score); if(r<=0){chosen=c;break;} }

    const cellX0=chosen.cx*cellW, cellY0=chosen.cy*cellH;
    const loX=clamp(cellX0+p+half,minX,maxX), hiX=clamp(cellX0+cellW-p-half,minX,maxX);
    const loY=clamp(cellY0+p+half,minY,maxY), hiY=clamp(cellY0+cellH-p-half,minY,maxY);

    const minDistFromLast = Math.max(s*1.05, 28);

    let best=null, bestScore=-Infinity;
    for(let i=0;i<260;i++){
      const x=loX+Math.random()*(hiX-loX);
      const y=loY+Math.random()*(hiY-loY);
      if(!okCenter(x,y)) continue;
      if(lastPt && dist({x,y}, lastPt) < minDistFromLast) continue;
      let dSum=0; for(let k=0;k<recent.length;k++) dSum += dist({x,y}, recent[k])*(k===0?1:0.35);
      const sc=dSum+Math.random()*70;
      if(sc>bestScore){bestScore=sc;best={x,y};}
    }
    if(!best) best={x:minX,y:minY};

    pushHistory(best);
    cellCounts.set(chosen.k, getCount(chosen.k)+1);
    lastCell = chosen.k;
    return best;
  }

  function placePreview(){
    const {w,h} = stageWH();
    const pt = pickPosition_inSpace(w,h);
    sprite.style.left = pt.x + "px";
    sprite.style.top  = pt.y + "px";
    sprite.style.transform = "translate(-50%,-50%)";
  }

  // ---------- build GENIALLY code with FULLSCREEN FIX (scale-aware) ----------
  function buildGeniallyCode(){
    const c = readCfg();
    const cfgJson = JSON.stringify({
      imgUrl: c.imgUrl || "",
      defaultBase: c.defaultBase || DEFAULT_BASE,
      size: c.size,
      rounds: c.rounds,
      pad: c.pad,
      pause: c.pause,
      anim: c.anim,
      dur: c.dur,
      task: c.task || "",
      endText: c.endText || "",
      arrowW: c.arrowW,
      arrowH: c.arrowH,
      logoW: c.logoW,
      logoH: c.logoH
    });

    return `<div id="FX_ROOT">
  <style>
    #FX_ROOT{position:relative;width:100%;height:100%;overflow:hidden;background:transparent;font-family:system-ui,-apple-system,Segoe UI,Roboto;}
    #FX_ROOT .topBanner{position:absolute;top:14px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.55);border:1px solid rgba(255,255,255,.12);border-radius:999px;padding:8px 14px;font-size:14px;color:rgba(255,255,255,.92);box-shadow:0 10px 30px rgba(0,0,0,.25);pointer-events:none;max-width:min(720px, calc(100% - 180px));text-align:center;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;z-index:5;}
    #FX_ROOT .hud{position:absolute;top:14px;right:14px;display:flex;gap:10px;align-items:center;z-index:6;}
    #FX_ROOT .lamp{width:38px;height:38px;border-radius:50%;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.14);display:grid;place-items:center;cursor:pointer;user-select:none;box-shadow:0 10px 30px rgba(0,0,0,.25);}
    #FX_ROOT .count{background:rgba(0,0,0,.45);border:1px solid rgba(255,255,255,.12);padding:6px 10px;border-radius:999px;font-size:13px;color:rgba(255,255,255,.92);min-width:52px;text-align:center;box-shadow:0 10px 30px rgba(0,0,0,.25);}
    #FX_ROOT .sprite{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);cursor:pointer;user-select:none;-webkit-user-drag:none;will-change:transform,opacity,filter;z-index:4;}
    #FX_ROOT .anim-none{opacity:1;}
    #FX_ROOT .anim-pop{animation:popIn var(--dur) ease-out both;}
    @keyframes popIn{from{transform:translate(-50%,-50%) scale(.6);opacity:0;}to{transform:translate(-50%,-50%) scale(1);opacity:1;}}
    #FX_ROOT .anim-fade{animation:fadeIn var(--dur) ease-out both;}
    @keyframes fadeIn{from{opacity:0;}to{opacity:1;}}
    #FX_ROOT .anim-soft{animation:softIn var(--dur) ease-out both;}
    @keyframes softIn{from{opacity:0;filter:blur(6px);}to{opacity:1;filter:blur(0);}}
    #FX_ROOT .pulseHint{animation:pulse 700ms ease-in-out 0s 3;}
    @keyframes pulse{0%,100%{transform:translate(-50%,-50%) scale(1);}50%{transform:translate(-50%,-50%) scale(1.15);}}
  </style>

  <div class="topBanner" id="fx_banner"></div>
  <div class="hud">
    <div class="lamp" id="fx_lamp" title="–ü–æ–¥—Å–∫–∞–∑–∫–∞">üí°</div>
    <div class="count" id="fx_count"></div>
  </div>
  <img class="sprite" id="fx_sprite" alt="sprite" />

  <scr` + `ipt>
  (function(){
    const root = document.getElementById('FX_ROOT');
    const banner = document.getElementById('fx_banner');
    const count  = document.getElementById('fx_count');
    const lamp   = document.getElementById('fx_lamp');
    const sprite = document.getElementById('fx_sprite');
    const cfg = ${cfgJson};

    const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
    const dist=(a,b)=>Math.hypot(a.x-b.x, a.y-b.y);
    const intersects=(a,b)=>!(a.x + a.w <= b.x || a.x >= b.x + b.w || a.y + a.h <= b.y || a.y >= b.y + b.h);

    let found = 0;
    let history = [];
    const HISTORY_MAX = 14;
    let cellCounts = new Map();
    let lastCell = null;

    // ‚úÖ –í–∏–∑—É–∞–ª—å–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã + –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã –º–∞—Å—à—Ç–∞–±–∞ (—ç—Ç–æ –∏ –ª–µ—á–∏—Ç fullscreen Genially)
    function space(){
      const r = root.getBoundingClientRect();
      const lw = root.clientWidth || root.offsetWidth || 1;
      const lh = root.clientHeight || root.offsetHeight || 1;
      const sx = r.width  / lw;
      const sy = r.height / lh;
      return {vw:Math.max(1,r.width), vh:Math.max(1,r.height), lw, lh, sx: (sx||1), sy:(sy||1)};
    }

    function buildForbiddenRects(vw,vh,p,logoW,logoH,arrowW,arrowH){
      const bannerH=92, bannerW=Math.min(760, vw-220), bannerX=(vw-bannerW)/2;
      const logoX=0, logoY=vh-logoH;
      const aw=clamp(arrowW,60,320), ah=clamp(arrowH,120,560), arrowY=(vh-ah)/2;
      const hudW=120, hudH=70, hudX=vw-hudW, hudY=0;
      const padRect=(r)=>({x:r.x-p,y:r.y-p,w:r.w+p*2,h:r.h+p*2});
      return [
        padRect({x:bannerX,y:0,w:bannerW,h:bannerH}),
        padRect({x:logoX,y:logoY,w:logoW,h:logoH}),
        padRect({x:0,y:arrowY,w:aw,h:ah}),
        padRect({x:vw-aw,y:arrowY,w:aw,h:ah}),
        padRect({x:hudX,y:hudY,w:hudW,h:hudH}),
      ];
    }

    function pushHistory(pt){ history.unshift(pt); if(history.length>HISTORY_MAX) history.pop(); }

    function pickPosition_visual(vw,vh){
      const s = Math.max(10, cfg.size||46);
      const p = clamp(cfg.pad||0, 0, 240);
      const half = s/2;

      const minX=p+half, minY=p+half;
      const maxX=Math.max(minX, vw-p-half);
      const maxY=Math.max(minY, vh-p-half);

      const forbid = buildForbiddenRects(vw,vh,p,(cfg.logoW||170),(cfg.logoH||120),(cfg.arrowW||120),(cfg.arrowH||220));
      const cols=6, rows=5, cellW=vw/cols, cellH=vh/rows;

      const lastPt = history[0] || null;
      const recent = history.slice(0,7);

      const key=(cx,cy)=>cx+','+cy;
      const getCount=(k)=>cellCounts.get(k)||0;

      function okCenter(x,y){
        const r={x:x-half,y:y-half,w:s,h:s};
        for(const f of forbid) if(intersects(r,f)) return false;
        return true;
      }

      const cells=[];
      for(let cy=0;cy<rows;cy++) for(let cx=0;cx<cols;cx++){
        const k=key(cx,cy);
        const center={x:cx*cellW+cellW/2,y:cy*cellH+cellH/2};
        const rarity = 220/(1+getCount(k));
        const dLast = lastPt ? dist(center,lastPt) : 220;
        let dRecent=0; for(const rp of recent) dRecent += dist(center,rp);
        dRecent = recent.length ? dRecent/recent.length : 0;
        const repeatPenalty = (k===lastCell) ? 320 : 0;
        const score = rarity + dLast*1.05 + dRecent*0.35 + Math.random()*140 - repeatPenalty;
        cells.push({cx,cy,k,score});
      }
      cells.sort((a,b)=>b.score-a.score);

      const TOPK=Math.min(12,cells.length);
      const pool=cells.slice(0,TOPK);
      let sum=0; for(const c of pool) sum+=Math.max(1,c.score);
      let r=Math.random()*sum;
      let chosen=pool[0];
      for(const c of pool){ r-=Math.max(1,c.score); if(r<=0){chosen=c;break;} }

      const cellX0=chosen.cx*cellW, cellY0=chosen.cy*cellH;
      const loX=clamp(cellX0+p+half,minX,maxX), hiX=clamp(cellX0+cellW-p-half,minX,maxX);
      const loY=clamp(cellY0+p+half,minY,maxY), hiY=clamp(cellY0+cellH-p-half,minY,maxY);

      const minDistFromLast = Math.max(s*1.05, 28);

      let best=null, bestScore=-Infinity;
      for(let i=0;i<260;i++){
        const x=loX+Math.random()*(hiX-loX);
        const y=loY+Math.random()*(hiY-loY);
        if(!okCenter(x,y)) continue;
        if(lastPt && dist({x,y}, lastPt) < minDistFromLast) continue;
        let dSum=0; for(let k=0;k<recent.length;k++) dSum += dist({x,y}, recent[k])*(k===0?1:0.35);
        const sc=dSum+Math.random()*70;
        if(sc>bestScore){bestScore=sc;best={x,y};}
      }
      if(!best) best={x:minX,y:minY};

      pushHistory(best);
      cellCounts.set(chosen.k, getCount(chosen.k)+1);
      lastCell = chosen.k;
      return best;
    }

    function applyAnim(){
      sprite.style.setProperty('--dur', Math.max(0, cfg.dur||0)+'ms');
      sprite.classList.remove('anim-none','anim-pop','anim-fade','anim-soft');
      if(cfg.anim==='none') sprite.classList.add('anim-none');
      if(cfg.anim==='pop')  sprite.classList.add('anim-pop');
      if(cfg.anim==='fade') sprite.classList.add('anim-fade');
      if(cfg.anim==='soft') sprite.classList.add('anim-soft');
    }
    function setSize(){
      sprite.style.width=(cfg.size||46)+'px';
      sprite.style.height=(cfg.size||46)+'px';
    }
    function setTexts(){
      banner.textContent = cfg.task || '';
      count.textContent  = found + '/' + (cfg.rounds||7);
    }

    async function tryLoadFetch(url){
      try{
        const bust=url+(url.includes('?')?'&':'?')+'v='+Date.now();
        const res=await fetch(bust,{cache:'no-store'});
        if(!res.ok) return null;
        const blob=await res.blob();
        if(!blob||blob.size<10) return null;
        return URL.createObjectURL(blob);
      }catch(e){ return null; }
    }
    function candidates(){
      const u=(cfg.imgUrl||'').trim();
      if(u) return [u];
      const base=(cfg.defaultBase||'').trim();
      return [base, base+'.png', base+'.webp', base+'.jpg', base+'.svg'].filter(Boolean);
    }
    async function loadSprite(){
      if(sprite.dataset.objurl){ try{URL.revokeObjectURL(sprite.dataset.objurl);}catch(e){} sprite.dataset.objurl=''; }
      for(const u of candidates()){
        const obj=await tryLoadFetch(u);
        if(obj){ sprite.src=obj; sprite.dataset.objurl=obj; return true; }
      }
      return false;
    }

    function placeNow(){
      const sp = space();
      if(sp.vw < 200 || sp.vh < 150) return; // —Å–ª–∏—à–∫–æ–º —Ä–∞–Ω–æ/–µ—â—ë –Ω–µ —Ä–∞–∑–≤–µ—Ä–Ω—É–ª–æ—Å—å
      const ptV = pickPosition_visual(sp.vw, sp.vh);

      // ‚úÖ –ø–µ—Ä–µ–≤–æ–¥ –∏–∑ –≤–∏–∑—É–∞–ª—å–Ω—ã—Ö –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –≤ layout (—á—Ç–æ–±—ã transform:scale –Ω–µ —É–≤–æ–¥–∏–ª –∑–∞ —ç–∫—Ä–∞–Ω)
      const lx = ptV.x / sp.sx;
      const ly = ptV.y / sp.sy;

      sprite.style.left = lx + 'px';
      sprite.style.top  = ly + 'px';
      sprite.style.transform='translate(-50%,-50%)';
    }

    function schedulePlace(){
      // –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ç–∏–∫–æ–≤ ‚Äî –ø–æ—Ç–æ–º—É —á—Ç–æ Genially –≤ fullscreen –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Ä–∞–∑–º–µ—Ä—ã –∫–∞—Å–∫–∞–¥–æ–º
      setTimeout(placeNow, 0);
      setTimeout(placeNow, 80);
      setTimeout(placeNow, 180);
      setTimeout(placeNow, 360);
      setTimeout(placeNow, 640);
    }

    function nextRound(){
      if(found >= (cfg.rounds||7)){
        banner.textContent = cfg.endText || '';
        sprite.style.display = 'none';
        return;
      }
      sprite.style.display = '';
      applyAnim();
      schedulePlace();
      setTexts();
    }

    sprite.addEventListener('click', ()=>{
      found++;
      sprite.style.display='none';
      setTexts();
      setTimeout(nextRound, Math.max(0, cfg.pause||0));
    });

    lamp.addEventListener('click', ()=>{
      sprite.classList.remove('pulseHint'); void sprite.offsetWidth; sprite.classList.add('pulseHint');
    });

    setSize(); applyAnim(); setTexts();
    loadSprite().then(()=>{ schedulePlace(); });

    if('ResizeObserver' in window){
      const ro = new ResizeObserver(()=>schedulePlace());
      ro.observe(root);
    }
    window.addEventListener('resize', ()=>schedulePlace(), {passive:true});
  })();
  <\/scr` + `ipt>
</div>`;
  }

  async function copyText(text){
    try{ await navigator.clipboard.writeText(text); return true; }
    catch(e){
      const ta=document.createElement("textarea");
      ta.value=text; ta.style.position="fixed"; ta.style.left="-9999px";
      document.body.appendChild(ta); ta.select();
      const ok=document.execCommand("copy");
      document.body.removeChild(ta);
      return ok;
    }
  }

  $("btnCode").addEventListener("click", ()=>{
    $("out").value = buildGeniallyCode();
    $("out").scrollTop = 0;
  });
  $("btnCopy").addEventListener("click", async ()=>{
    if(!$("out").value.trim()) $("out").value = buildGeniallyCode();
    await copyText($("out").value);
  });

  $("btnReset").addEventListener("click", async ()=>{
    found=0;
    history=[]; cellCounts.clear(); lastCell=null;
    updateUI();
    await setSpriteSource();
    sprite.style.display="";
    placePreview();
  });

  sprite.addEventListener("click", async ()=>{
    found++;
    updateUI();
    sprite.style.display = "none";
    const pause = Math.max(0, cfg.pause|0);
    if(pause) await new Promise(r=>setTimeout(r,pause));
    if(found >= cfg.rounds){
      banner.textContent = cfg.endText || "";
      return;
    }
    sprite.style.display = "";
    applyAnim();
    placePreview();
    count.textContent = `${found}/${cfg.rounds}`;
  });

  lamp.addEventListener("click", ()=>{
    sprite.classList.remove("pulseHint");
    void sprite.offsetWidth;
    sprite.classList.add("pulseHint");
  });

  const inputs = ["imgUrl","size","rounds","pad","pause","anim","dur","task","endText","arrowW","arrowH","logoBox"];
  inputs.forEach(id=>{
    $(id).addEventListener("input", async ()=>{
      updateUI();
      await setSpriteSource();
      placePreview();
    });
    $(id).addEventListener("change", async ()=>{
      updateUI();
      await setSpriteSource();
      placePreview();
    });
  });

  async function init(){
    updateUI();
    await setSpriteSource();
    found=0;
    history=[]; cellCounts.clear(); lastCell=null;
    sprite.style.display="";
    placePreview();
  }
  init();
})();
</script>
</body>
</html>
