<div id="FX_ROOT">
  <style>
    #FX_ROOT{position:relative;width:100%;height:100%;overflow:hidden;background:transparent;}

    #FX_ROOT .fx_prog{
      position:absolute; right:14px; top:14px; z-index:999999;
      background:rgba(0,0,0,.45); border:1px solid rgba(255,255,255,.18);
      padding:6px 10px; border-radius:999px; font-size:12px; color:rgba(255,255,255,.9);
      backdrop-filter: blur(6px);
      pointer-events:none;
      user-select:none;
    }
    #FX_ROOT .fx_hintBtn{
      position:absolute; right:64px; top:12px;
      z-index:1000000;
      width:38px; height:38px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(0,0,0,.35);
      color:rgba(255,255,255,.92);
      font-size:18px;
      cursor:pointer;
      display:flex; align-items:center; justify-content:center;
      backdrop-filter: blur(6px);
      box-shadow: 0 12px 30px rgba(0,0,0,.18);
      -webkit-tap-highlight-color: transparent;
      user-select:none;
    }
    #FX_ROOT .fx_hintBtn:hover{ background:rgba(0,0,0,.45); }
    #FX_ROOT .fx_hintBtn:active{ transform: translateY(1px); }
    #FX_ROOT .fx_hintBtn:disabled{ opacity:.45; cursor:not-allowed; }

    #FX_ROOT .fx_task{
      position:absolute; left:50%; top:18px; transform:translateX(-50%);
      z-index:999998;
      max-width:min(720px, calc(100% - 40px));
      background:rgba(0,0,0,.42);
      border:1px solid rgba(255,255,255,.18);
      border-radius:14px;
      padding:10px 14px;
      color:rgba(255,255,255,.95);
      font:700 14px/1.25 system-ui,-apple-system,Segoe UI,Roboto,Arial;
      text-align:center;
      backdrop-filter: blur(8px);
      pointer-events:none;
      user-select:none;
      box-shadow: 0 12px 30px rgba(0,0,0,.22);
    }

    #FX_ROOT .fx_target{
      position:absolute; z-index:999999;
      cursor:pointer; user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    #FX_ROOT .fx_target img{display:block;width:100%;height:100%;object-fit:contain}

    #FX_ROOT .fx_final{
      position:absolute; inset:0; z-index:1000001;
      display:none; align-items:center; justify-content:center;
      padding:24px;
      background:rgba(0,0,0,.18);
      backdrop-filter: blur(2px);
      pointer-events:none;
    }
    #FX_ROOT .fx_finalCard{
      max-width:min(760px, calc(100% - 40px));
      background:rgba(0,0,0,.55);
      border:1px solid rgba(255,255,255,.18);
      border-radius:18px;
      padding:18px 18px;
      color:rgba(255,255,255,.96);
      font:800 18px/1.25 system-ui,-apple-system,Segoe UI,Roboto,Arial;
      text-align:center;
      box-shadow: 0 18px 50px rgba(0,0,0,.28);
    }

    @keyframes fxFadeIn{from{opacity:0} to{opacity:1}}
    @keyframes fxPopIn{0%{opacity:0; transform:scale(.7)} 100%{opacity:1; transform:scale(1)}}
    @keyframes fxSlideIn{0%{opacity:0; transform:translateY(-10px)} 100%{opacity:1; transform:translateY(0)}}
    @keyframes fxWiggle{0%{opacity:0; transform:scale(.9) rotate(-4deg)} 70%{opacity:1; transform:scale(1.02) rotate(2deg)} 100%{opacity:1; transform:scale(1) rotate(0deg)}}
    @keyframes fxSoftFade{0%{opacity:0; transform:scale(.96)} 100%{opacity:1; transform:scale(1)}}

    #FX_ROOT .fx-none{}
    #FX_ROOT .fx-fade{animation: fxFadeIn var(--dur,500ms) ease-out}
    #FX_ROOT .fx-pop{animation: fxPopIn var(--dur,500ms) cubic-bezier(.2,.8,.2,1)}
    #FX_ROOT .fx-slide{animation: fxSlideIn var(--dur,500ms) ease-out}
    #FX_ROOT .fx-wiggle{animation: fxWiggle var(--dur,650ms) cubic-bezier(.2,.8,.2,1)}
    #FX_ROOT .fx-softfade{animation: fxSoftFade var(--dur,1100ms) ease-out}

    @keyframes fxHintPulse{
      0%   { transform:scale(1);   opacity:1; filter:drop-shadow(0 0 0 rgba(120,220,255,0)); }
      20%  { transform:scale(1.25);opacity:1; filter:drop-shadow(0 0 14px rgba(120,220,255,.95)); }
      40%  { transform:scale(1);   opacity:.35; filter:drop-shadow(0 0 0 rgba(120,220,255,0)); }
      60%  { transform:scale(1.25);opacity:1; filter:drop-shadow(0 0 16px rgba(120,220,255,.98)); }
      80%  { transform:scale(1);   opacity:.35; filter:drop-shadow(0 0 0 rgba(120,220,255,0)); }
      100% { transform:scale(1);   opacity:1; filter:drop-shadow(0 0 0 rgba(120,220,255,0)); }
    }
    #FX_ROOT .fx_target.fx-hint img{ animation: fxHintPulse 900ms ease-in-out 0s 2; }
  </style>

  <div class="fx_prog"></div>
  <button class="fx_hintBtn" type="button" aria-label="–ü–æ–¥—Å–∫–∞–∑–∫–∞" title="–ü–æ–¥—Å–∫–∞–∑–∫–∞">üí°</button>
  <div class="fx_task"></div>
  <div class="fx_target"><img alt=""></div>

  <div class="fx_final">
    <div class="fx_finalCard"></div>
  </div>

  <script>
  (function(){
    const root = document.getElementById('FX_ROOT');
    if(!root) return;

    // ====== –ù–ê–°–¢–†–û–ô–ö–ò (–º–æ–∂–Ω–æ –º–µ–Ω—è—Ç—å –ø—Ä—è–º–æ —Ç—É—Ç, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ) ======
    const cfg = {
      url: "https://propodgotovkaa-creator.github.io/babochka_2/babushka_2?img=1",
      size: 46,
      rounds: 7,
      task: "–ù–∞–π–¥–∏ –±–∞–±–æ—á–∫—É –∏ –Ω–∞–∂–º–∏ –Ω–∞ –Ω–µ—ë!",
      endText: "–ú–æ–ª–æ–¥–µ—Ü! –ü—Ä–∏—Ö–æ–¥–∏ –∏–≥—Ä–∞—Ç—å –µ—â—ë —Ä–∞–∑ üòä",
      anim: "softfade",  // none | softfade | fade | pop | slide | wiggle
      dur: 1100,
      pad: 12,           // –æ—Ç—Å—Ç—É–ø –æ—Ç –∫—Ä–∞—ë–≤
      gap: 200           // –ø–∞—É–∑–∞ –º–µ–∂–¥—É —Ä–∞—É–Ω–¥–∞–º–∏
    };
    // ===========================================================

    const progEl = root.querySelector('.fx_prog');
    const hintBtn = root.querySelector('.fx_hintBtn');
    const taskEl = root.querySelector('.fx_task');
    const target = root.querySelector('.fx_target');
    const img = target.querySelector('img');
    const final = root.querySelector('.fx_final');
    const finalCard = root.querySelector('.fx_finalCard');

    let found = 0;
    let last = {x:null, y:null};

    const HISTORY_MAX = 14;
    const history = [];

    function pushHistory(pt){
      history.push({x:pt.x, y:pt.y});
      if(history.length > HISTORY_MAX) history.shift();
    }

    function clamp(n,a,b){ return Math.max(a, Math.min(b, n)); }

    function rect(){
      const r = root.getBoundingClientRect();
      return {w: Math.max(1, r.width), h: Math.max(1, r.height)};
    }

    function intersects(a, b){
      return !(a.x + a.w <= b.x || b.x + b.w <= a.x || a.y + a.h <= b.y || b.y + b.h <= a.y);
    }

    function toRootRect(el){
      const sr = root.getBoundingClientRect();
      const r = el.getBoundingClientRect();
      return { x: r.left - sr.left, y: r.top - sr.top, w: r.width, h: r.height };
    }

    // ‚úÖ –≤–∞–∂–Ω–æ –¥–ª—è Genially: –¥–æ–∂–¥–∞—Ç—å—Å—è —Å—Ç–∞–±–∏–ª—å–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
    function waitForStableSize(cb){
      let lastKey = null;
      let stable = 0;
      const tick = ()=>{
        const r = root.getBoundingClientRect();
        const key = Math.round(r.width) + 'x' + Math.round(r.height);
        if(key === lastKey){
          stable++;
          if(stable >= 3){ cb(); return; }
        } else { lastKey = key; stable = 0; }
        requestAnimationFrame(tick);
      };
      tick();
    }

    function setAnim(){
      target.classList.remove('fx-none','fx-fade','fx-pop','fx-slide','fx-wiggle','fx-softfade','fx-hint');
      const v = cfg.anim || 'none';
      target.classList.add(v==='none' ? 'fx-none' : ('fx-'+v));
      target.style.setProperty('--dur', Math.max(0, cfg.dur|0) + 'ms');
    }

    function updateUI(){
      const total = Math.max(1, cfg.rounds|0);
      progEl.textContent = found + '/' + total;
      taskEl.textContent = (cfg.task || '–ù–∞–π–¥–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞!').trim();
      finalCard.textContent = (cfg.endText || '–ú–æ–ª–æ–¥–µ—Ü!').trim();
      target.style.width  = (cfg.size|0) + 'px';
      target.style.height = (cfg.size|0) + 'px';
    }

    function distanceToHistory(pt){
      if(history.length === 0) return Infinity;
      let minD = Infinity;
      for(const p of history){
        const d = Math.hypot(pt.x - p.x, pt.y - p.y);
        if(d < minD) minD = d;
      }
      return minD;
    }

    function getForbiddenRects(){
      const rects = [];
      const padUI = 10;

      // –ø–ª–∞—à–∫–∏ UI
      for(const el of [taskEl, progEl, hintBtn]){
        const r = toRootRect(el);
        rects.push({ x:r.x-padUI, y:r.y-padUI, w:r.w+padUI*2, h:r.h+padUI*2 });
      }

      const {w,h} = rect();

      // –ª–æ–≥–æ—Ç–∏–ø Genially (—Å–ª–µ–≤–∞ —Å–Ω–∏–∑—É)
      const logoW = 190, logoH = 70, logoPad = 8;
      rects.push({ x: 0, y: h - logoH - logoPad, w: logoW + logoPad, h: logoH + logoPad });

      // ‚úÖ –∑–æ–Ω–∞ —Å—Ç—Ä–µ–ª–∫–∏ "—Å–ª–µ–¥—É—é—â–∏–π —Å–ª–∞–π–¥" ‚Äî —Ç–æ–ª—å–∫–æ –ø—è—Ç–Ω–æ –ø–æ —Ü–µ–Ω—Ç—Ä—É —Å–ø—Ä–∞–≤–∞
      const arrowW = 80;
      const arrowH = 160;
      const arrowPad = 10;
      rects.push({
        x: w - arrowW - arrowPad,
        y: (h - arrowH) / 2,
        w: arrowW + arrowPad,
        h: arrowH
      });

      return rects;
    }

    function randomPos(){
      const {w,h} = rect();
      const s = Math.max(1, cfg.size|0);
      const p = clamp(cfg.pad|0, 0, 240);

      const forbid = getForbiddenRects();
      const candidateRect = (pt)=>({x:pt.x,y:pt.y,w:s,h:s});

      // ‚úÖ –°–µ—Ç–∫–∞ 4x3 ‚Äî –∑–∞—Å—Ç–∞–≤–ª—è–µ—Ç —Ö–æ–¥–∏—Ç—å –ø–æ —Ä–∞–∑–Ω—ã–º –æ–±–ª–∞—Å—Ç—è–º (–≤–∫–ª—é—á–∞—è –Ω–∏–∑ –∏ —É–≥–ª—ã)
      const cols = 4, rows = 3;
      const cellW = w / cols;
      const cellH = h / rows;

      // –∫–∞–∫–∏–µ –∫–ª–µ—Ç–∫–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏—Å—å
      const cellUse = new Array(cols*rows).fill(0);
      for(const pt of history){
        const cx = Math.min(cols-1, Math.max(0, Math.floor(pt.x / cellW)));
        const cy = Math.min(rows-1, Math.max(0, Math.floor(pt.y / cellH)));
        cellUse[cy*cols + cx]++;
      }
      // —Å–Ω–∞—á–∞–ª–∞ —Ä–µ–¥–∫–∏–µ –∫–ª–µ—Ç–∫–∏
      const order = [...cellUse.keys()].sort((a,b)=>cellUse[a]-cellUse[b]);

      function tryInCell(idx, tries){
        const cx = idx % cols;
        const cy = Math.floor(idx / cols);

        const minX = Math.max(p, cx*cellW + p);
        const maxX = Math.min(w - p - s, (cx+1)*cellW - p - s);
        const minY = Math.max(p, cy*cellH + p);
        const maxY = Math.min(h - p - s, (cy+1)*cellH - p - s);

        if(maxX <= minX || maxY <= minY) return null;

        let best=null, bestScore=-1;
        for(let i=0;i<tries;i++){
          const pt = {
            x: minX + Math.random()*(maxX-minX),
            y: minY + Math.random()*(maxY-minY),
          };
          const cr = candidateRect(pt);
          if(forbid.some(fr => intersects(cr, fr))) continue;

          const dHist = distanceToHistory(pt);
          const dLast = (last.x===null) ? dHist : Math.hypot(pt.x-last.x, pt.y-last.y);

          // –æ—á–∫–∏: –¥–∞–ª—å—à–µ –æ—Ç –∏—Å—Ç–æ—Ä–∏–∏/–ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ + –Ω–µ–±–æ–ª—å—à–æ–π —à—É–º
          const score = dHist*1.05 + dLast*0.35 + Math.random()*12;
          if(score > bestScore){ bestScore=score; best=pt; }
        }
        return best;
      }

      // –ø—Ä–æ–±—É–µ–º —Ä–µ–¥–∫–∏–µ –∫–ª–µ—Ç–∫–∏
      let best = null;
      for(const idx of order){
        best = tryInCell(idx, 55);
        if(best) break;
      }

      // fallback –æ–±—â–∏–π
      if(!best){
        const minX = p, minY = p;
        const maxX = Math.max(minX, w - p - s);
        const maxY = Math.max(minY, h - p - s);
        for(let k=0;k<180;k++){
          const pt = { x:minX+Math.random()*(maxX-minX), y:minY+Math.random()*(maxY-minY) };
          const cr = candidateRect(pt);
          if(!forbid.some(fr => intersects(cr, fr))){
            best = pt; break;
          }
        }
        if(!best) best = {x:minX,y:minY};
      }

      last = best;
      pushHistory(best);
      return best;
    }

    function place(){
      const pos = randomPos();
      target.style.left = pos.x + 'px';
      target.style.top  = pos.y + 'px';
    }

    function showFinal(){
      target.style.display = 'none';
      final.style.display = 'flex';
      hintBtn.disabled = true;
    }
    function hideFinal(){
      final.style.display = 'none';
      hintBtn.disabled = false;
    }

    function next(){
      const total = Math.max(1, cfg.rounds|0);
      if(found >= total){ showFinal(); return; }
      hideFinal();
      target.style.display = '';

      target.classList.remove('fx-none','fx-fade','fx-pop','fx-slide','fx-wiggle','fx-softfade','fx-hint');
      void target.offsetWidth;

      setAnim();
      place();
      updateUI();
    }

    function runHint(){
      if(final.style.display === 'flex') return;

      const wasHidden = (target.style.display === 'none');
      if(wasHidden) target.style.display = '';

      target.classList.remove('fx-hint');
      void target.offsetWidth;
      target.classList.add('fx-hint');

      setTimeout(()=>{
        target.classList.remove('fx-hint');
        if(wasHidden) target.style.display = 'none';
      }, 2000);
    }

    hintBtn.addEventListener('click', runHint);

    target.addEventListener('click', ()=>{
      const total = Math.max(1, cfg.rounds|0);
      if(found >= total) return;

      found++;
      updateUI();
      target.style.display = 'none';
      setTimeout(next, Math.max(0, cfg.gap|0));
    });

    // –ø–æ–¥—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–∏ —Ä–µ—Å–∞–π–∑–µ
    const ro = ('ResizeObserver' in window) ? new ResizeObserver(()=>{ if(target.style.display!=='none') place(); }) : null;
    if(ro) ro.observe(root);
    window.addEventListener('resize', ()=>{ if(target.style.display!=='none') place(); }, {passive:true});

    // –∑–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ä—Ç–∏–Ω–∫–∏
    img.referrerPolicy = 'no-referrer';
    img.src = cfg.url;

    // —Å—Ç–∞—Ä—Ç
    waitForStableSize(()=>{
      updateUI();
      next();
      // —Å—Ç—Ä–∞—Ö–æ–≤–∫–∞: UI Genially –º–æ–∂–µ—Ç –¥–æ—Ä–∏—Å–æ–≤–∞—Ç—å—Å—è –ø–æ–∑–∂–µ
      setTimeout(()=>{ if(target.style.display!=='none') place(); }, 350);
      setTimeout(()=>{ if(target.style.display!=='none') place(); }, 900);
    });
  })();
  </script>
</div>
