<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,height=device-height,initial-scale=1.0" />
<title>–†–µ–¥–∞–∫—Ç–æ—Ä ¬´–ù–∞–π–¥–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞¬ª</title>
<style>
  :root{
    --bg1:#0b1020;
    --bg2:#0f1832;
    --panel:rgba(20,24,40,.75);
    --stroke:rgba(255,255,255,.10);
    --txt:rgba(255,255,255,.92);
    --muted:rgba(255,255,255,.65);
    --btn:#2d6cff;
    --ok:#22c55e;
    --bad:#ef4444;
  }
  html,body{margin:0;height:100%;background:var(--bg1);font-family:system-ui,-apple-system,Segoe UI,Roboto; color:var(--txt); overflow:hidden;}
  .app{
    position:fixed; inset:0;
    display:grid;
    grid-template-columns: 380px 1fr;
    gap:14px;
    padding:14px;
    box-sizing:border-box;
  }
  @media (max-width: 980px){
    .app{grid-template-columns:1fr; grid-template-rows:auto 1fr;}
  }
  .panel{
    background:var(--panel);
    border:1px solid var(--stroke);
    border-radius:18px;
    padding:14px 14px 12px;
    overflow:auto;
    backdrop-filter: blur(10px);
  }
  .title{font-size:18px; font-weight:700; margin:0 0 8px;}
  .desc{font-size:12px; color:var(--muted); line-height:1.35; margin:0 0 12px;}
  .field{margin:10px 0;}
  label{display:block;font-size:12px;color:var(--muted); margin:0 0 4px;}
  input,select,textarea{
    width:100%; box-sizing:border-box;
    background:#101a36;
    border:1px solid rgba(255,255,255,.10);
    color:var(--txt);
    border-radius:10px;
    padding:8px 10px;
    outline:none;
  }
  input[type="range"]{padding:0; height:28px;}
  textarea{min-height:70px; resize:vertical;}
  .row{display:grid; grid-template-columns:1fr 1fr; gap:10px;}
  .row3{display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px;}
  .btnRow{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;}
  button{
    border:none; border-radius:12px;
    padding:10px 12px;
    cursor:pointer;
    font-weight:700;
    color:white;
    background:rgba(255,255,255,.12);
  }
  button.primary{background:var(--btn);}
  button.success{background:var(--ok); color:#062012;}
  button.ghost{background:rgba(255,255,255,.10);}
  .codeBox{
    margin-top:10px;
    border:1px solid rgba(255,255,255,.10);
    border-radius:14px;
    background:rgba(0,0,0,.25);
    padding:10px;
  }
  .codeBox .cap{font-size:12px;color:var(--muted); margin:0 0 8px;}
  #out{
    width:100%;
    min-height:140px;
    font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
    font-size:12px;
    line-height:1.35;
    white-space:pre;
  }
  .hint{
    margin-top:8px;
    font-size:12px;
    color:var(--muted);
  }
  .warn{
    margin-top:8px;
    font-size:12px;
    color:#ffd27a;
    display:none;
  }

  /* stage */
  .stage{
    position:relative;
    border-radius:18px;
    overflow:hidden;
    border:1px solid var(--stroke);
    background:
      repeating-linear-gradient(135deg, rgba(255,255,255,.05) 0, rgba(255,255,255,.05) 8px, rgba(255,255,255,.02) 8px, rgba(255,255,255,.02) 16px),
      linear-gradient(180deg, rgba(15,24,50,.55), rgba(0,0,0,.25));
  }
  .topBanner{
    position:absolute;
    top:14px;
    left:50%;
    transform:translateX(-50%);
    background:rgba(0,0,0,.55);
    border:1px solid rgba(255,255,255,.12);
    border-radius:999px;
    padding:8px 14px;
    font-size:14px;
    box-shadow:0 10px 30px rgba(0,0,0,.25);
    pointer-events:none;
    max-width:min(720px, calc(100% - 180px));
    text-align:center;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .hud{
    position:absolute;
    top:14px;
    right:14px;
    display:flex;
    gap:10px;
    align-items:center;
    z-index:5;
  }
  .lamp{
    width:38px; height:38px;
    border-radius:50%;
    border:1px solid rgba(255,255,255,.14);
    background:rgba(255,255,255,.14);
    display:grid; place-items:center;
    cursor:pointer;
    user-select:none;
    box-shadow:0 10px 30px rgba(0,0,0,.25);
  }
  .lamp:active{transform:translateY(1px);}
  .count{
    background:rgba(0,0,0,.45);
    border:1px solid rgba(255,255,255,.12);
    padding:6px 10px;
    border-radius:999px;
    font-size:13px;
    min-width:52px;
    text-align:center;
    box-shadow:0 10px 30px rgba(0,0,0,.25);
  }
  .sprite{
    position:absolute;
    left:50%; top:50%;
    transform:translate(-50%,-50%);
    cursor:pointer;
    user-select:none;
    -webkit-user-drag:none;
    will-change: transform, opacity, filter;
  }

  /* preview forbidden overlays (debug) */
  .forbidDebug{
    position:absolute;
    pointer-events:none;
    border:1px dashed rgba(255,255,255,.14);
    background:rgba(255,255,255,.03);
    border-radius:10px;
    z-index:1;
    display:none;
  }
  .showDebug .forbidDebug{display:block;}

  /* anim presets */
  .anim-none{opacity:1;}
  .anim-pop{animation:popIn var(--dur) ease-out both;}
  @keyframes popIn{from{transform:translate(-50%,-50%) scale(.6); opacity:0;} to{transform:translate(-50%,-50%) scale(1); opacity:1;}}
  .anim-fade{animation:fadeIn var(--dur) ease-out both;}
  @keyframes fadeIn{from{opacity:0;} to{opacity:1;}}
  .anim-soft{animation:softIn var(--dur) ease-out both;}
  @keyframes softIn{from{opacity:0; filter:blur(6px);} to{opacity:1; filter:blur(0);}}
  .pulseHint{animation:pulse 700ms ease-in-out 0s 3;}
  @keyframes pulse{0%,100%{transform:translate(-50%,-50%) scale(1);}50%{transform:translate(-50%,-50%) scale(1.15);}}
</style>
</head>
<body>

<div class="app" id="APP">
  <div class="panel">
    <div class="title">–†–µ–¥–∞–∫—Ç–æ—Ä ¬´–ù–∞–π–¥–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞¬ª</div>
    <p class="desc">
      –≠—Ç–æ —Ä–µ–¥–∞–∫—Ç–æ—Ä (–ø–∞–Ω–µ–ª—å —Å–ª–µ–≤–∞) + –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä (—Å–ø—Ä–∞–≤–∞).<br>
      1) –ù–∞—Å—Ç—Ä–æ–π –ø–∞—Ä–∞–º–µ—Ç—Ä—ã ‚Üí 2) –ù–∞–∂–º–∏ ¬´–ü–æ–ª—É—á–∏—Ç—å –∫–æ–¥¬ª ‚Üí 3) –í—Å—Ç–∞–≤—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ Genially (HTML/Embed).
    </p>

    <div class="field">
      <label>URL –∫–∞—Ä—Ç–∏–Ω–∫–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ (–º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –ø—É—Å—Ç—ã–º)</label>
      <input id="imgUrl" placeholder="https://.../image.png">
      <div class="hint">–ï—Å–ª–∏ –ø—É—Å—Ç–æ ‚Äî –≤–æ–∑—å–º—ë–º –ª–æ–∫–∞–ª—å–Ω—ã–π —Ñ–∞–π–ª —Ä—è–¥–æ–º —Å <b>index.html</b>: <b>babushka_2</b> –∏–ª–∏ <b>babushka_2.png</b></div>
      <div class="warn" id="imgWarn">‚ö†Ô∏è –ö–∞—Ä—Ç–∏–Ω–∫–∞ –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–∞—Å—å. –ü—Ä–æ–≤–µ—Ä—å URL –∏–ª–∏ –∏–º—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ñ–∞–π–ª–∞.</div>
    </div>

    <div class="row">
      <div class="field">
        <label>–†–∞–∑–º–µ—Ä (px)</label>
        <input type="range" id="size" min="20" max="180" value="46">
        <div class="hint"><span id="sizeVal">46</span> px</div>
      </div>
      <div class="field">
        <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞—Ö–æ–¥–æ–∫ (—Ä–∞—É–Ω–¥–æ–≤)</label>
        <input type="number" id="rounds" min="1" max="50" value="7">
      </div>
    </div>

    <div class="row">
      <div class="field">
        <label>–û—Ç—Å—Ç—É–ø –æ—Ç –∫—Ä–∞—ë–≤ (px)</label>
        <input type="number" id="pad" min="0" max="240" value="12">
      </div>
      <div class="field">
        <label>–ü–∞—É–∑–∞ –º–µ–∂–¥—É —Ä–∞—É–Ω–¥–∞–º–∏ (–º—Å)</label>
        <input type="number" id="pause" min="0" max="5000" value="200">
      </div>
    </div>

    <div class="row">
      <div class="field">
        <label>–ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è</label>
        <select id="anim">
          <option value="soft">soft fade (–º–µ–¥–ª–µ–Ω–Ω–æ)</option>
          <option value="fade">fade</option>
          <option value="pop">pop</option>
          <option value="none">–±–µ–∑ –∞–Ω–∏–º–∞—Ü–∏–∏</option>
        </select>
      </div>
      <div class="field">
        <label>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∞–Ω–∏–º–∞—Ü–∏–∏ (–º—Å)</label>
        <input type="number" id="dur" min="0" max="5000" value="1100">
      </div>
    </div>

    <div class="field">
      <label>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è (–ø–ª–∞—à–∫–∞ —Å–≤–µ—Ä—Ö—É –ø–æ —Ü–µ–Ω—Ç—Ä—É)</label>
      <input id="task" value="–ù–∞–π–¥–∏ –±–∞–±–æ—á–∫—É –∏ –Ω–∞–∂–º–∏ –Ω–∞ –Ω–µ—ë!">
    </div>

    <div class="field">
      <label>–¢–µ–∫—Å—Ç –≤ –∫–æ–Ω—Ü–µ –∏–≥—Ä—ã</label>
      <textarea id="endText">–ú–æ–ª–æ–¥–µ—Ü! –ü—Ä–∏—Ö–æ–¥–∏ –∏–≥—Ä–∞—Ç—å –µ—â—ë —Ä–∞–∑ üòä</textarea>
    </div>

    <div class="row">
      <div class="field">
        <label>–ó–æ–Ω–∞ —Å—Ç—Ä–µ–ª–æ–∫ —Å–ª–µ–≤–∞/—Å–ø—Ä–∞–≤–∞ (px)</label>
        <input type="number" id="arrowW" min="60" max="220" value="120">
        <div class="hint">–®–∏—Ä–∏–Ω–∞ –∑–∞–ø—Ä–µ—Ç–Ω–æ–π –∑–æ–Ω—ã –ø–æ –∫—Ä–∞—è–º (–¥–ª—è —Å—Ç—Ä–µ–ª–æ–∫ –Ω–∞–∑–∞–¥/–≤–ø–µ—Ä—ë–¥)</div>
      </div>
      <div class="field">
        <label>–í—ã—Å–æ—Ç–∞ –∑–æ–Ω—ã —Å—Ç—Ä–µ–ª–æ–∫ (px)</label>
        <input type="number" id="arrowH" min="120" max="360" value="220">
        <div class="hint">–í—ã—Å–æ—Ç–∞ –∑–∞–ø—Ä–µ—Ç–Ω–æ–π –∑–æ–Ω—ã –ø–æ —Ü–µ–Ω—Ç—Ä—É —Å–ª–µ–≤–∞/—Å–ø—Ä–∞–≤–∞</div>
      </div>
    </div>

    <div class="row">
      <div class="field">
        <label>–õ–æ–≥–æ Genially —Å–ª–µ–≤–∞ —Å–Ω–∏–∑—É (w√óh, px)</label>
        <input type="text" id="logoBox" value="170x120">
        <div class="hint">–§–æ—Ä–º–∞—Ç: 170x120</div>
      </div>
      <div class="field">
        <label>–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –∑–∞–ø—Ä–µ—Ç–Ω—ã–µ –∑–æ–Ω—ã (debug)</label>
        <select id="debug">
          <option value="0">–Ω–µ—Ç</option>
          <option value="1">–¥–∞</option>
        </select>
      </div>
    </div>

    <div class="btnRow">
      <button class="primary" id="btnCode">–ü–æ–ª—É—á–∏—Ç—å –∫–æ–¥</button>
      <button class="success" id="btnCopy">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥</button>
      <button class="ghost" id="btnReset">–°–±—Ä–æ—Å</button>
    </div>

    <div class="codeBox">
      <div class="cap">HTML-–∫–æ–¥ –¥–ª—è Genially (DIV + STYLE + SCRIPT)</div>
      <textarea id="out" readonly placeholder="–ù–∞–∂–º–∏ ¬´–ü–æ–ª—É—á–∏—Ç—å –∫–æ–¥¬ª"></textarea>
      <div class="hint">–í—Å—Ç–∞–≤–ª—è–π –≤ Genially ‚Üí <b>Insert ‚Üí Others ‚Üí Embed ‚Üí Insert external content</b> (HTML/Embed).</div>
    </div>
  </div>

  <div class="stage" id="stage">
    <div class="topBanner" id="banner">–ù–∞–π–¥–∏ –±–∞–±–æ—á–∫—É –∏ –Ω–∞–∂–º–∏ –Ω–∞ –Ω–µ—ë!</div>

    <div class="hud">
      <div class="lamp" id="lamp" title="–ü–æ–¥—Å–∫–∞–∑–∫–∞">üí°</div>
      <div class="count" id="count">0/7</div>
    </div>

    <!-- debug forbidden rectangles -->
    <div class="forbidDebug" id="dbg1"></div>
    <div class="forbidDebug" id="dbg2"></div>
    <div class="forbidDebug" id="dbg3"></div>
    <div class="forbidDebug" id="dbg4"></div>
    <div class="forbidDebug" id="dbg5"></div>

    <img class="sprite" id="sprite" alt="sprite" />
  </div>
</div>

<script>
(() => {
  // ---------- helpers ----------
  const $ = (id)=>document.getElementById(id);
  const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
  const parseBox=(s,defW,defH)=>{
    const m = String(s||"").toLowerCase().match(/(\d+)\s*x\s*(\d+)/);
    if(!m) return {w:defW,h:defH};
    return {w:+m[1],h:+m[2]};
  };

  // ---------- state ----------
  const stage = $("stage");
  const sprite = $("sprite");
  const banner = $("banner");
  const count = $("count");
  const lamp  = $("lamp");
  const imgWarn = $("imgWarn");
  const APP = $("APP");

  let cfg = {};
  let found = 0;
  let history = []; // positions history to avoid repeats
  const HISTORY_MAX = 12;

  function readCfg(){
    const logo = parseBox($("logoBox").value, 170, 120);
    cfg = {
      imgUrl: $("imgUrl").value.trim(),
      size: +$("size").value,
      rounds: +$("rounds").value,
      pad: +$("pad").value,
      pause: +$("pause").value,
      anim: $("anim").value,
      dur: +$("dur").value,
      task: $("task").value,
      endText: $("endText").value,
      arrowW: +$("arrowW").value,
      arrowH: +$("arrowH").value,
      logoW: logo.w,
      logoH: logo.h,
      debug: $("debug").value === "1",
    };
    $("sizeVal").textContent = String(cfg.size);
    return cfg;
  }

  function stageRect(){
    const r = stage.getBoundingClientRect();
    return {w: r.width, h:r.height};
  }

  function buildForbiddenRects(){
    const {w,h} = stageRect();
    const p = clamp(cfg.pad, 0, 240);

    // 1) instruction banner (top center)
    // reserve some max width & height
    const bannerH = 92;
    const bannerW = Math.min(760, w - 220);
    const bannerX = (w - bannerW)/2;
    const bannerY = 0;

    // 2) logo genially bottom-left
    const logoX = 0;
    const logoY = h - cfg.logoH;

    // 3) arrows left/right
    const aw = clamp(cfg.arrowW, 60, 220);
    const ah = clamp(cfg.arrowH, 120, 360);
    const arrowY = (h - ah)/2;

    // 4) top-right HUD (lamp+counter) small area
    const hudW = 120;
    const hudH = 70;
    const hudX = w - hudW;
    const hudY = 0;

    // add padding around forbidden areas a bit
    const padRect = (r)=>({x:r.x - p, y:r.y - p, w:r.w + p*2, h:r.h + p*2});

    const rects = [
      padRect({x:bannerX,y:bannerY,w:bannerW,h:bannerH}),
      padRect({x:logoX,y:logoY,w:cfg.logoW,h:cfg.logoH}),
      padRect({x:0,y:arrowY,w:aw,h:ah}),
      padRect({x:w-aw,y:arrowY,w:aw,h:ah}),
      padRect({x:hudX,y:hudY,w:hudW,h:hudH}),
    ];

    // debug draw
    const dbg = [$("dbg1"),$("dbg2"),$("dbg3"),$("dbg4"),$("dbg5")];
    dbg.forEach((el,i)=>{
      const r = rects[i];
      el.style.left = r.x+"px";
      el.style.top  = r.y+"px";
      el.style.width = r.w+"px";
      el.style.height= r.h+"px";
    });

    return rects;
  }

  function intersects(a, b){
    return !(a.x + a.w <= b.x || a.x >= b.x + b.w || a.y + a.h <= b.y || a.y >= b.y + b.h);
  }

  function pushHistory(pt){
    history.unshift(pt);
    if(history.length > HISTORY_MAX) history.pop();
  }

  function dist(a,b){
    const dx = (a.x-b.x), dy=(a.y-b.y);
    return Math.hypot(dx,dy);
  }

  // –ö–õ–Æ–ß–ï–í–û–ï: –Ω–æ–≤—ã–π –∞–ª–≥–æ—Ä–∏—Ç–º –ø–æ–∑–∏—Ü–∏–∏.
  // 1) –¥–µ–ª–∏–º —Å—Ü–µ–Ω—É –Ω–∞ —Å–µ—Ç–∫—É 5x4
  // 2) –≤—ã–±–∏—Ä–∞–µ–º —è—á–µ–π–∫–∏ –≤ —Ä–∞–∑–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ
  // 3) –≤ –∫–∞–∂–¥–æ–π —è—á–µ–π–∫–µ –ø—Ä–æ–±—É–µ–º –º–Ω–æ–≥–æ —Ç–æ—á–µ–∫
  // 4) –æ—Ü–µ–Ω–∏–≤–∞–µ–º "–Ω–∞—Å–∫–æ–ª—å–∫–æ –¥–∞–ª–µ–∫–æ –æ—Ç –∏—Å—Ç–æ—Ä–∏–∏"
  function pickPosition(){
    const {w,h} = stageRect();
    const s = Math.max(10, cfg.size);
    const p = clamp(cfg.pad, 0, 240);

    // safe bounds
    const minX = p;
    const minY = p;
    const maxX = Math.max(minX, w - p - s);
    const maxY = Math.max(minY, h - p - s);

    const forbid = buildForbiddenRects();

    // if stage too small, fallback
    if(maxX - minX < 1 || maxY - minY < 1){
      return {x:minX, y:minY};
    }

    // grid
    const cols = 5, rows = 4;
    const cellW = w / cols;
    const cellH = h / rows;

    // cell usage (avoid repeating same cells)
    const cellScore = [];
    for(let cy=0; cy<rows; cy++){
      for(let cx=0; cx<cols; cx++){
        // center of cell
        const c = {x:cx*cellW + cellW/2, y:cy*cellH + cellH/2};
        // score = farther from recent positions
        let score = 0;
        if(history.length){
          const d0 = dist(c, history[0]);
          const d1 = history[1] ? dist(c, history[1]) : d0;
          score = d0*1.0 + d1*0.4 + Math.random()*50;
        }else{
          score = Math.random()*1000;
        }
        cellScore.push({cx,cy,score});
      }
    }
    // sort by best score desc
    cellScore.sort((a,b)=>b.score-a.score);

    function ok(x,y){
      const r = {x, y, w:s, h:s};
      for(const f of forbid){
        if(intersects(r,f)) return false;
      }
      return true;
    }

    // try best cells first
    for(const cs of cellScore){
      const cellX0 = cs.cx * cellW;
      const cellY0 = cs.cy * cellH;

      // compute allowed region inside cell
      const loX = clamp(cellX0 + p, minX, maxX);
      const hiX = clamp(cellX0 + cellW - p - s, minX, maxX);
      const loY = clamp(cellY0 + p, minY, maxY);
      const hiY = clamp(cellY0 + cellH - p - s, minY, maxY);

      if(hiX < loX || hiY < loY) continue;

      // many attempts in this cell
      let best = null;
      let bestScore = -Infinity;
      for(let i=0;i<60;i++){
        const x = loX + Math.random()*(hiX-loX);
        const y = loY + Math.random()*(hiY-loY);
        if(!ok(x,y)) continue;

        // distance score from history (avoid repeats)
        let d = 0;
        for(let k=0;k<Math.min(history.length,6);k++){
          d += dist({x,y}, history[k]) * (k===0?1:0.35);
        }
        const sc = d + Math.random()*30;
        if(sc > bestScore){
          bestScore = sc;
          best = {x,y};
        }
      }
      if(best){
        pushHistory(best);
        return best;
      }
    }

    // fallback: relax and brute force anywhere
    for(let i=0;i<500;i++){
      const x = minX + Math.random()*(maxX-minX);
      const y = minY + Math.random()*(maxY-minY);
      if(ok(x,y)){
        const pt={x,y};
        pushHistory(pt);
        return pt;
      }
    }

    // final fallback
    const pt={x:minX,y:minY};
    pushHistory(pt);
    return pt;
  }

  function setSpriteSize(){
    sprite.style.width = cfg.size + "px";
    sprite.style.height = cfg.size + "px";
  }

  function applyAnim(){
    sprite.style.setProperty("--dur", Math.max(0,cfg.dur)+"ms");
    sprite.classList.remove("anim-none","anim-pop","anim-fade","anim-soft");
    if(cfg.anim==="none") sprite.classList.add("anim-none");
    if(cfg.anim==="pop")  sprite.classList.add("anim-pop");
    if(cfg.anim==="fade") sprite.classList.add("anim-fade");
    if(cfg.anim==="soft") sprite.classList.add("anim-soft");
  }

  function placeNow(){
    const pt = pickPosition();
    sprite.style.left = pt.x + "px";
    sprite.style.top  = pt.y + "px";
    // sprite uses translate(-50%,-50%), so move anchor to center:
    // we set left/top as center coords
    sprite.style.transform = "translate(-50%,-50%)";
  }

  function spriteLoadUrl(){
    // –ï—Å–ª–∏ –ø—É—Å—Ç–æ ‚Äî –ø—Ä–æ–±—É–µ–º —Ä–∞–∑–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã —Ä—è–¥–æ–º —Å index.html
    const u = (cfg.imgUrl||"").trim();
    if(u) return [u];

    // –í–ê–ñ–ù–û: —É —Ç–µ–±—è —Ñ–∞–π–ª –º–æ–∂–µ—Ç –±—ã—Ç—å –±–µ–∑ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è, –ª–∏–±–æ .png
    // –ø—Ä–æ–±—É–µ–º –ø–æ –æ—á–µ—Ä–µ–¥–∏
    return ["./babushka_2", "./babushka_2.png", "./babushka_2.webp", "./babushka_2.jpg"];
  }

  async function setSpriteSource(){
    imgWarn.style.display = "none";
    const list = spriteLoadUrl();
    // –ø—Ä–æ–±—É–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø–æ –æ—á–µ—Ä–µ–¥–∏
    for(const u of list){
      const ok = await new Promise(res=>{
        const im = new Image();
        im.onload = ()=>res(true);
        im.onerror = ()=>res(false);
        im.src = u + (u.includes("?") ? "&" : "?") + "v=" + Date.now();
      });
      if(ok){
        // —Å—Ç–∞–≤–∏–º –±–µ–∑ cache-bust, –∏–Ω–∞—á–µ Genially –º–æ–∂–µ—Ç –Ω–µ –∫–µ—à–∏—Ä–æ–≤–∞—Ç—å –Ω–æ—Ä–º–∞–ª—å–Ω–æ
        sprite.src = u;
        return true;
      }
    }
    // –Ω–∏—á–µ–≥–æ –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–æ—Å—å
    sprite.removeAttribute("src");
    imgWarn.style.display = "block";
    return false;
  }

  function updateUI(){
    readCfg();
    banner.textContent = cfg.task || "";
    count.textContent = `${found}/${cfg.rounds}`;
    APP.classList.toggle("showDebug", cfg.debug);
    setSpriteSize();
    applyAnim();
  }

  // ---------- preview/game in editor ----------
  function resetGame(){
    found = 0;
    history = [];
    updateUI();
    placeNow();
  }

  function nextRound(){
    if(found >= cfg.rounds){
      banner.textContent = cfg.endText || "";
      sprite.style.display = "none";
      return;
    }
    sprite.style.display = "";
    applyAnim();
    placeNow();
  }

  sprite.addEventListener("click", async ()=>{
    // click = found
    found++;
    updateUI();
    sprite.style.display = "none";
    // –ø–∞—É–∑–∞
    const pause = Math.max(0, cfg.pause|0);
    if(pause) await new Promise(r=>setTimeout(r,pause));
    nextRound();
  });

  lamp.addEventListener("click", ()=>{
    // –ø–æ–¥—Å–∫–∞–∑–∫–∞: –ø—É–ª—å—Å–∞—Ü–∏—è
    sprite.classList.remove("pulseHint");
    // reflow
    void sprite.offsetWidth;
    sprite.classList.add("pulseHint");
  });

  // ---------- code generator for Genially ----------
  function escHtml(s){
    return String(s)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;");
  }

  function buildGeniallyCode(){
    // –í—Å—ë —Å–∞–º–æ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ: DIV + STYLE + SCRIPT
    // –í–Ω—É—Ç—Ä–∏ ‚Äî —Ç–æ—Ç –∂–µ –∞–ª–≥–æ—Ä–∏—Ç–º –ø–æ–∑–∏—Ü–∏–∏, –∑–∞–ø—Ä–µ—Ç–Ω—ã–µ –∑–æ–Ω—ã –∏ –ø–æ–¥—Å–∫–∞–∑–∫–∞.

    const c = readCfg();
    const cfgJson = JSON.stringify({
      imgUrl: c.imgUrl || "",
      size: c.size,
      rounds: c.rounds,
      pad: c.pad,
      pause: c.pause,
      anim: c.anim,
      dur: c.dur,
      task: c.task || "",
      endText: c.endText || "",
      arrowW: c.arrowW,
      arrowH: c.arrowH,
      logoW: c.logoW,
      logoH: c.logoH
    });

    // –í–°–¢–ê–í–ö–ê: –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –≥–æ—Ç–æ–≤—ã–π –±–ª–æ–∫
    return `<div id="FX_ROOT">
  <style>
    #FX_ROOT{position:relative;width:100%;height:100%;overflow:hidden;background:transparent;font-family:system-ui,-apple-system,Segoe UI,Roboto;}
    #FX_ROOT .topBanner{
      position:absolute; top:14px; left:50%; transform:translateX(-50%);
      background:rgba(0,0,0,.55);
      border:1px solid rgba(255,255,255,.12);
      border-radius:999px; padding:8px 14px; font-size:14px; color:rgba(255,255,255,.92);
      box-shadow:0 10px 30px rgba(0,0,0,.25);
      pointer-events:none;
      max-width:min(720px, calc(100% - 180px));
      text-align:center; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      z-index:5;
    }
    #FX_ROOT .hud{
      position:absolute; top:14px; right:14px; display:flex; gap:10px; align-items:center; z-index:6;
    }
    #FX_ROOT .lamp{
      width:38px; height:38px; border-radius:50%;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.14);
      display:grid; place-items:center; cursor:pointer; user-select:none;
      box-shadow:0 10px 30px rgba(0,0,0,.25);
    }
    #FX_ROOT .count{
      background:rgba(0,0,0,.45);
      border:1px solid rgba(255,255,255,.12);
      padding:6px 10px; border-radius:999px; font-size:13px; color:rgba(255,255,255,.92);
      min-width:52px; text-align:center;
      box-shadow:0 10px 30px rgba(0,0,0,.25);
    }
    #FX_ROOT .sprite{
      position:absolute; left:50%; top:50%;
      transform:translate(-50%,-50%);
      cursor:pointer; user-select:none; -webkit-user-drag:none;
      will-change: transform, opacity, filter;
      z-index:4;
    }
    #FX_ROOT .anim-none{opacity:1;}
    #FX_ROOT .anim-pop{animation:popIn var(--dur) ease-out both;}
    @keyframes popIn{from{transform:translate(-50%,-50%) scale(.6);opacity:0;}to{transform:translate(-50%,-50%) scale(1);opacity:1;}}
    #FX_ROOT .anim-fade{animation:fadeIn var(--dur) ease-out both;}
    @keyframes fadeIn{from{opacity:0;}to{opacity:1;}}
    #FX_ROOT .anim-soft{animation:softIn var(--dur) ease-out both;}
    @keyframes softIn{from{opacity:0;filter:blur(6px);}to{opacity:1;filter:blur(0);}}
    #FX_ROOT .pulseHint{animation:pulse 700ms ease-in-out 0s 3;}
    @keyframes pulse{0%,100%{transform:translate(-50%,-50%) scale(1);}50%{transform:translate(-50%,-50%) scale(1.15);}}
  </style>

  <div class="topBanner" id="fx_banner"></div>
  <div class="hud">
    <div class="lamp" id="fx_lamp" title="–ü–æ–¥—Å–∫–∞–∑–∫–∞">üí°</div>
    <div class="count" id="fx_count"></div>
  </div>
  <img class="sprite" id="fx_sprite" alt="sprite" />

  <script>
  (function(){
    const root = document.getElementById('FX_ROOT');
    const banner = document.getElementById('fx_banner');
    const count  = document.getElementById('fx_count');
    const lamp   = document.getElementById('fx_lamp');
    const sprite = document.getElementById('fx_sprite');

    const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
    const dist=(a,b)=>Math.hypot(a.x-b.x,a.y-b.y);

    const cfg = ${cfgJson};
    let found = 0;
    let history = [];
    const HISTORY_MAX = 12;

    function rectWH(){
      const r = root.getBoundingClientRect();
      return {w:r.width, h:r.height};
    }

    function intersects(a,b){
      return !(a.x + a.w <= b.x || a.x >= b.x + b.w || a.y + a.h <= b.y || a.y >= b.y + b.h);
    }

    function buildForbiddenRects(){
      const {w,h} = rectWH();
      const p = clamp(cfg.pad||0, 0, 240);

      const bannerH = 92;
      const bannerW = Math.min(760, w - 220);
      const bannerX = (w - bannerW)/2;
      const bannerY = 0;

      const logoX = 0;
      const logoY = h - (cfg.logoH||120);

      const aw = clamp(cfg.arrowW||120, 60, 220);
      const ah = clamp(cfg.arrowH||220, 120, 360);
      const arrowY = (h - ah)/2;

      const hudW = 120, hudH = 70;
      const hudX = w - hudW, hudY = 0;

      const padRect = (r)=>({x:r.x - p, y:r.y - p, w:r.w + p*2, h:r.h + p*2});

      return [
        padRect({x:bannerX,y:bannerY,w:bannerW,h:bannerH}),
        padRect({x:logoX,y:logoY,w:(cfg.logoW||170),h:(cfg.logoH||120)}),
        padRect({x:0,y:arrowY,w:aw,h:ah}),
        padRect({x:w-aw,y:arrowY,w:aw,h:ah}),
        padRect({x:hudX,y:hudY,w:hudW,h:hudH}),
      ];
    }

    function pushHistory(pt){
      history.unshift(pt);
      if(history.length > HISTORY_MAX) history.pop();
    }

    function pickPosition(){
      const {w,h} = rectWH();
      const s = Math.max(10, cfg.size||46);
      const p = clamp(cfg.pad||0, 0, 240);

      const minX = p;
      const minY = p;
      const maxX = Math.max(minX, w - p - s);
      const maxY = Math.max(minY, h - p - s);

      const forbid = buildForbiddenRects();
      if(maxX - minX < 1 || maxY - minY < 1){
        return {x:minX, y:minY};
      }

      const cols = 5, rows = 4;
      const cellW = w / cols;
      const cellH = h / rows;

      const cellScore = [];
      for(let cy=0; cy<rows; cy++){
        for(let cx=0; cx<cols; cx++){
          const c = {x:cx*cellW + cellW/2, y:cy*cellH + cellH/2};
          let score = 0;
          if(history.length){
            const d0 = dist(c, history[0]);
            const d1 = history[1] ? dist(c, history[1]) : d0;
            score = d0*1.0 + d1*0.4 + Math.random()*50;
          }else{
            score = Math.random()*1000;
          }
          cellScore.push({cx,cy,score});
        }
      }
      cellScore.sort((a,b)=>b.score-a.score);

      function ok(x,y){
        const r = {x, y, w:s, h:s};
        for(const f of forbid) if(intersects(r,f)) return false;
        return true;
      }

      for(const cs of cellScore){
        const cellX0 = cs.cx * cellW;
        const cellY0 = cs.cy * cellH;

        const loX = clamp(cellX0 + p, minX, maxX);
        const hiX = clamp(cellX0 + cellW - p - s, minX, maxX);
        const loY = clamp(cellY0 + p, minY, maxY);
        const hiY = clamp(cellY0 + cellH - p - s, minY, maxY);
        if(hiX < loX || hiY < loY) continue;

        let best=null, bestScore=-Infinity;
        for(let i=0;i<60;i++){
          const x = loX + Math.random()*(hiX-loX);
          const y = loY + Math.random()*(hiY-loY);
          if(!ok(x,y)) continue;

          let d=0;
          for(let k=0;k<Math.min(history.length,6);k++){
            d += dist({x,y}, history[k]) * (k===0?1:0.35);
          }
          const sc = d + Math.random()*30;
          if(sc>bestScore){bestScore=sc; best={x,y};}
        }
        if(best){pushHistory(best); return best;}
      }

      for(let i=0;i<500;i++){
        const x = minX + Math.random()*(maxX-minX);
        const y = minY + Math.random()*(maxY-minY);
        if(ok(x,y)){const pt={x,y}; pushHistory(pt); return pt;}
      }

      const pt={x:minX,y:minY}; pushHistory(pt); return pt;
    }

    function applyAnim(){
      sprite.style.setProperty('--dur', Math.max(0, cfg.dur||0)+'ms');
      sprite.classList.remove('anim-none','anim-pop','anim-fade','anim-soft');
      if(cfg.anim==='none') sprite.classList.add('anim-none');
      if(cfg.anim==='pop')  sprite.classList.add('anim-pop');
      if(cfg.anim==='fade') sprite.classList.add('anim-fade');
      if(cfg.anim==='soft') sprite.classList.add('anim-soft');
    }

    function setSize(){
      const s = cfg.size||46;
      sprite.style.width = s+'px';
      sprite.style.height= s+'px';
    }

    function setTexts(){
      banner.textContent = cfg.task || '';
      count.textContent  = found + '/' + (cfg.rounds||7);
    }

    function spriteLoadCandidates(){
      const u = (cfg.imgUrl||'').trim();
      if(u) return [u];
      return ['./babushka_2','./babushka_2.png','./babushka_2.webp','./babushka_2.jpg'];
    }

    function tryLoad(list, i){
      return new Promise((res)=>{
        if(i>=list.length){res(false); return;}
        const url=list[i];
        const im=new Image();
        im.onload=()=>{sprite.src=url; res(true);};
        im.onerror=()=>{tryLoad(list,i+1).then(res);};
        im.src = url + (url.includes('?')?'&':'?') + 'v=' + Date.now();
      });
    }

    function placeNow(){
      const pt = pickPosition();
      sprite.style.left = pt.x+'px';
      sprite.style.top  = pt.y+'px';
      sprite.style.transform = 'translate(-50%,-50%)';
    }

    function nextRound(){
      if(found >= (cfg.rounds||7)){
        banner.textContent = cfg.endText || '';
        sprite.style.display='none';
        return;
      }
      sprite.style.display='';
      applyAnim();
      placeNow();
      setTexts();
    }

    sprite.addEventListener('click', ()=>{
      found++;
      sprite.style.display='none';
      setTexts();
      const pause = Math.max(0, cfg.pause||0);
      setTimeout(nextRound, pause);
    });

    lamp.addEventListener('click', ()=>{
      sprite.classList.remove('pulseHint');
      void sprite.offsetWidth;
      sprite.classList.add('pulseHint');
    });

    // init
    setSize();
    applyAnim();
    setTexts();
    tryLoad(spriteLoadCandidates(),0).then(()=>{
      // start position after image loads (or not)
      placeNow();
      setTexts();
    });

    // responsive reposition on resize
    let t=null;
    window.addEventListener('resize', ()=>{
      clearTimeout(t);
      t=setTimeout(()=>{placeNow();}, 150);
    });
  })();
  </script>
</div>`;
  }

  // ---------- clipboard ----------
  async function copyText(text){
    try{
      await navigator.clipboard.writeText(text);
      return true;
    }catch(e){
      // fallback
      const ta = document.createElement("textarea");
      ta.value = text;
      ta.style.position="fixed";
      ta.style.left="-9999px";
      document.body.appendChild(ta);
      ta.select();
      const ok = document.execCommand("copy");
      document.body.removeChild(ta);
      return ok;
    }
  }

  // ---------- UI events ----------
  function bind(){
    const inputs = ["imgUrl","size","rounds","pad","pause","anim","dur","task","endText","arrowW","arrowH","logoBox","debug"];
    inputs.forEach(id=>{
      $(id).addEventListener("input", ()=>{
        updateUI();
        // –Ω–µ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –ø—Ä–∏ –∫–∞–∂–¥–æ–º –≤–≤–æ–¥–µ ‚Äî —Ç–æ–ª—å–∫–æ –ø–µ—Ä–µ–ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º/–æ–±–Ω–æ–≤–ª—è–µ–º
        setSpriteSource().then(()=>{ placeNow(); });
        count.textContent = `${found}/${cfg.rounds}`;
      });
      $(id).addEventListener("change", ()=>{
        updateUI();
        setSpriteSource().then(()=>{ placeNow(); });
      });
    });

    $("btnReset").addEventListener("click", ()=>{
      // –º—è–≥–∫–∏–π —Å–±—Ä–æ—Å —Ç–æ–ª—å–∫–æ –∏–≥—Ä—ã –∏ –∏—Å—Ç–æ—Ä–∏–∏
      resetGame();
      setSpriteSource().then(()=>{ sprite.style.display=""; });
    });

    $("btnCode").addEventListener("click", ()=>{
      const code = buildGeniallyCode();
      $("out").value = code;
      $("out").scrollTop = 0;
    });

    $("btnCopy").addEventListener("click", async ()=>{
      const val = $("out").value.trim();
      if(!val){
        const code = buildGeniallyCode();
        $("out").value = code;
      }
      await copyText($("out").value);
    });
  }

  // ---------- init ----------
  async function init(){
    readCfg();
    updateUI();
    bind();

    // –∞–≤—Ç–æ-–ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∫–∞–∫ —Ä–∞–Ω—å—à–µ: —Å—Ä–∞–∑—É –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –±–∞–±–æ—á–∫—É
    await setSpriteSource();
    resetGame();
    sprite.style.display = "";
  }

  init();
})();
</script>

</body>
</html>
